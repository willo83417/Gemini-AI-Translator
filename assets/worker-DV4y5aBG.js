var Bo=Object.defineProperty;var Co=(N,R,ue)=>R in N?Bo(N,R,{enumerable:!0,configurable:!0,writable:!0,value:ue}):N[R]=ue;var Ie=(N,R,ue)=>Co(N,typeof R!="symbol"?R+"":R,ue);(function(){"use strict";var N=typeof self<"u"?self:{};function R(e,t){e:{for(var r=["CLOSURE_FLAGS"],n=N,o=0;o<r.length;o++)if((n=n[r[o]])==null){r=null;break e}r=n}return(e=r&&r[e])!=null?e:t}let ue;const In=typeof TextEncoder<"u";function qt(e){if(In)e=(ue||(ue=new TextEncoder)).encode(e);else{let r=0;const n=new Uint8Array(3*e.length);for(let o=0;o<e.length;o++){var t=e.charCodeAt(o);if(t<128)n[r++]=t;else{if(t<2048)n[r++]=t>>6|192;else{if(t>=55296&&t<=57343){if(t<=56319&&o<e.length){const i=e.charCodeAt(++o);if(i>=56320&&i<=57343){t=1024*(t-55296)+i-56320+65536,n[r++]=t>>18|240,n[r++]=t>>12&63|128,n[r++]=t>>6&63|128,n[r++]=63&t|128;continue}o--}t=65533}n[r++]=t>>12|224,n[r++]=t>>6&63|128}n[r++]=63&t|128}}e=r===n.length?n:n.subarray(0,r)}return e}var wt,Ln=R(610401301,!1),Kt=R(748402147,!0),Pn=R(824656860,R(1,!0));function Yt(){var e=N.navigator;return e&&(e=e.userAgent)?e:""}const Jt=N.navigator;wt=Jt&&Jt.userAgentData||null;const Xt={};let Le=null;function On(e){const t=e.length;let r=3*t/4;r%3?r=Math.floor(r):"=.".indexOf(e[t-1])!=-1&&(r="=.".indexOf(e[t-2])!=-1?r-2:r-1);const n=new Uint8Array(r);let o=0;return function(i,s){function a(c){for(;l<i.length;){const u=i.charAt(l++),h=Le[u];if(h!=null)return h;if(!/^[\s\xa0]*$/.test(u))throw Error("Unknown base64 encoding at char: "+u)}return c}Qt();let l=0;for(;;){const c=a(-1),u=a(0),h=a(64),d=a(64);if(d===64&&c===-1)break;s(c<<2|u>>4),h!=64&&(s(u<<4&240|h>>2),d!=64&&s(h<<6&192|d))}}(e,function(i){n[o++]=i}),o!==r?n.subarray(0,o):n}function Qt(){if(!Le){Le={};var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),t=["+/=","+/","-_=","-_.","-_"];for(let r=0;r<5;r++){const n=e.concat(t[r].split(""));Xt[r]=n;for(let o=0;o<n.length;o++){const i=n[o];Le[i]===void 0&&(Le[i]=o)}}}}var xn=typeof Uint8Array<"u",Zt=!(!(Ln&&wt&&wt.brands.length>0)&&(Yt().indexOf("Trident")!=-1||Yt().indexOf("MSIE")!=-1))&&typeof btoa=="function";const er=/[-_.]/g,kn={"-":"+",_:"/",".":"="};function Un(e){return kn[e]||""}function tr(e){if(!Zt)return On(e);e=er.test(e)?e.replace(er,Un):e,e=atob(e);const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}function bt(e){return xn&&e!=null&&e instanceof Uint8Array}var Pe={};function vt(){return jn||(jn=new J(null,Pe))}var J=class{constructor(e,t){if(rr(t),this.i=e,e!=null&&e.length===0)throw Error("ByteString should be constructed with non-empty values")}};let jn,Mn;function rr(e){if(e!==Pe)throw Error("illegal external caller")}function nr(e,t){e.__closure__error__context__984382||(e.__closure__error__context__984382={}),e.__closure__error__context__984382.severity=t}function Oe(e){return nr(e=Error(e),"warning"),e}function $e(e,t){if(e!=null){var r=Mn??(Mn={}),n=r[e]||0;n>=t||(r[e]=n+1,nr(e=Error(),"incident"),function(o){N.setTimeout(()=>{throw o},0)}(e))}}function St(){return typeof BigInt=="function"}var He=typeof Symbol=="function"&&typeof Symbol()=="symbol";function xe(e,t,r=!1){return typeof Symbol=="function"&&typeof Symbol()=="symbol"?r&&Symbol.for&&e?Symbol.for(e):e!=null?Symbol(e):Symbol():t}var Bn=xe("jas",void 0,!0),ke=xe(void 0,"1oa"),Et=xe(void 0,"0ubsb"),Cn=xe(void 0,"0actk"),We=xe("m_m","pa",!0);const or={ha:{value:0,configurable:!0,writable:!0,enumerable:!1}},ir=Object.defineProperties,g=He?Bn:"ha";var he;const sr=[];function ar(e,t){He||g in e||ir(e,or),e[g]|=t}function k(e,t){He||g in e||ir(e,or),e[g]=t}k(sr,7),he=Object.freeze(sr);var qe={};function z(e,t){return t===void 0?e.i!==fe&&!!(2&(0|e.m[g])):!!(2&t)&&e.i!==fe}const fe={};var Nn=Object.freeze({});function Ke(e){return e.oa=!0,e}var Rn=Ke(e=>typeof e=="number"),lr=Ke(e=>typeof e=="string"),Dn=Ke(e=>typeof e=="boolean"),Ye=typeof N.BigInt=="function"&&typeof N.BigInt(0)=="bigint",Fn=Ke(e=>Ye?e>=Gn&&e<=$n:e[0]==="-"?cr(e,Vn):cr(e,zn));const Vn=Number.MIN_SAFE_INTEGER.toString(),Gn=Ye?BigInt(Number.MIN_SAFE_INTEGER):void 0,zn=Number.MAX_SAFE_INTEGER.toString(),$n=Ye?BigInt(Number.MAX_SAFE_INTEGER):void 0;function cr(e,t){if(e.length>t.length)return!1;if(e.length<t.length||e===t)return!0;for(let r=0;r<e.length;r++){const n=e[r],o=t[r];if(n>o)return!1;if(n<o)return!0}}let Hn,b=0,E=0;function ur(e){const t=e>>>0;b=t,E=(e-t)/4294967296>>>0}function Ue(e){if(e<0){ur(-e);const[t,r]=At(b,E);b=t>>>0,E=r>>>0}else ur(e)}function hr(e,t){const r=4294967296*t+(e>>>0);return Number.isSafeInteger(r)?r:Je(e,t)}function Je(e,t){if(e>>>=0,(t>>>=0)<=2097151)var r=""+(4294967296*t+e);else St()?r=""+(BigInt(t)<<BigInt(32)|BigInt(e)):(e=(16777215&e)+6777216*(r=16777215&(e>>>24|t<<8))+6710656*(t=t>>16&65535),r+=8147497*t,t*=2,e>=1e7&&(r+=e/1e7>>>0,e%=1e7),r>=1e7&&(t+=r/1e7>>>0,r%=1e7),r=t+fr(r)+fr(e));return r}function fr(e){return e=String(e),"0000000".slice(e.length)+e}function Xe(e){if(e.length<16)Ue(Number(e));else if(St())e=BigInt(e),b=Number(e&BigInt(4294967295))>>>0,E=Number(e>>BigInt(32)&BigInt(4294967295));else{const t=+(e[0]==="-");E=b=0;const r=e.length;for(let n=t,o=(r-t)%6+t;o<=r;n=o,o+=6){const i=Number(e.slice(n,o));E*=1e6,b=1e6*b+i,b>=4294967296&&(E+=Math.trunc(b/4294967296),E>>>=0,b>>>=0)}if(t){const[n,o]=At(b,E);b=n,E=o}}}function At(e,t){return t=~t,e?e=1+~e:t+=1,[e,t]}function je(e){return Array.prototype.slice.call(e)}const Wn=typeof BigInt=="function"?BigInt.asIntN:void 0,qn=typeof BigInt=="function"?BigInt.asUintN:void 0,Qe=Number.isSafeInteger,de=Number.isFinite,Ze=Math.trunc;function Tt(e){if(e!=null&&typeof e!="number")throw Error(`Value of float/double field must be a number, found ${typeof e}: ${e}`);return e}function dr(e){return e==null||typeof e=="number"?e:e==="NaN"||e==="Infinity"||e==="-Infinity"?Number(e):void 0}function ie(e){if(e!=null&&typeof e!="boolean"){var t=typeof e;throw Error(`Expected boolean but got ${t!="object"?t:e?Array.isArray(e)?"array":t:"null"}: ${e}`)}return e}function ee(e){return e==null||typeof e=="boolean"?e:typeof e=="number"?!!e:void 0}const Kn=/^-?([1-9][0-9]*|0)(\.[0-9]+)?$/;function pr(e){switch(typeof e){case"bigint":return!0;case"number":return de(e);case"string":return Kn.test(e);default:return!1}}function mr(e){if(typeof e!="number"||!de(e))throw Oe("int32");return 0|e}function It(e){return e==null?e:mr(e)}function pe(e){if(e==null)return e;if(typeof e=="string"&&e)e=+e;else if(typeof e!="number")return;return de(e)?0|e:void 0}function et(e){if(e==null)return e;if(typeof e=="string"&&e)e=+e;else if(typeof e!="number")return;return de(e)?e>>>0:void 0}function Lt(e){return e==null||typeof e=="string"?e:void 0}function gr(e,t,r){if(e!=null&&e[We]===qe)return e;if(Array.isArray(e)){var n=0|e[g];return(r=n|32&r|2&r)!==n&&k(e,r),new t(e)}}function tt(e,t,r,n){var o=n!==void 0;n=!!n;const i=[];var s=e.length;let a,l=4294967295,c=!1;const u=!!(64&t),h=u?128&t?0:-1:void 0;for(1&t||(a=s&&e[s-1],a!=null&&typeof a=="object"&&a.constructor===Object?l=--s:a=void 0,!u||128&t||o||(c=!0,l=l-h+h)),t=void 0,o=0;o<s;o++){let d=e[o];if(d!=null&&(d=r(d,n))!=null)if(u&&o>=l){const m=o-h;(t??(t={}))[m]=d}else i[o]=d}if(a)for(let d in a){if((e=a[d])==null||(e=r(e,n))==null)continue;let m;s=+d,u&&!Number.isNaN(s)&&(m=s+h)<l?i[m]=e:(t??(t={}))[d]=e}return t&&(c?i.push(t):i[l]=t),i}function Pt(e){switch(typeof e){case"number":return Number.isFinite(e)?e:""+e;case"bigint":return Fn(e)?Number(e):""+e;case"boolean":return e?1:0;case"object":if(Array.isArray(e)){var t=0|e[g];return e.length===0&&1&t?void 0:tt(e,t,Pt)}if(e!=null&&e[We]===qe)return yr(e);if(e instanceof J){if((t=e.i)==null)e="";else if(typeof t=="string")e=t;else{if(Zt){for(var r="",n=0,o=t.length-10240;n<o;)r+=String.fromCharCode.apply(null,t.subarray(n,n+=10240));r+=String.fromCharCode.apply(null,n?t.subarray(n):t),t=btoa(r)}else{r===void 0&&(r=0),Qt(),r=Xt[r],n=Array(Math.floor(t.length/3)),o=r[64]||"";let c=0,u=0;for(;c<t.length-2;c+=3){var i=t[c],s=t[c+1],a=t[c+2],l=r[i>>2];i=r[(3&i)<<4|s>>4],s=r[(15&s)<<2|a>>6],a=r[63&a],n[u++]=l+i+s+a}switch(l=0,a=o,t.length-c){case 2:a=r[(15&(l=t[c+1]))<<2]||o;case 1:t=t[c],n[u]=r[t>>2]+r[(3&t)<<4|l>>4]+a+o}t=n.join("")}e=e.i=t}return e}return}return e}function yr(e){return tt(e=e.m,0|e[g],Pt)}let Yn,Jn;function _r(e,t,r,n=0){if(e==null){var o=32;r?(e=[r],o|=128):e=[],t&&(o=-16760833&o|(1023&t)<<14)}else{if(!Array.isArray(e))throw Error("narr");if(o=0|e[g],Kt&&1&o)throw Error("rfarr");if(2048&o&&!(2&o)&&function(){if(Kt)throw Error("carr");$e(Cn,5)}(),256&o)throw Error("farr");if(64&o)return(o|n)!==o&&k(e,o|n),e;if(r&&(o|=128,r!==e[0]))throw Error("mid");e:{o|=64;var i=(r=e).length;if(i){var s=i-1;const l=r[s];if(l!=null&&typeof l=="object"&&l.constructor===Object){if((s-=t=128&o?0:-1)>=1024)throw Error("pvtlmt");for(var a in l)(i=+a)<s&&(r[i+t]=l[a],delete l[a]);o=-16760833&o|(1023&s)<<14;break e}}if(t){if((a=Math.max(t,i-(128&o?0:-1)))>1024)throw Error("spvt");o=-16760833&o|(1023&a)<<14}}}return k(e,64|o|n),e}function Xn(e,t){if(typeof e!="object")return e;if(Array.isArray(e)){var r=0|e[g];return e.length===0&&1&r?e=void 0:2&r||(!t||4096&r||16&r?e=rt(e,r,!1,t&&!(16&r)):(ar(e,34),4&r&&Object.freeze(e))),e}return e!=null&&e[We]===qe?z(e,r=0|(t=e.m)[g])?e:br(e,t,r)?wr(e,t):rt(t,r):e instanceof J?e:void 0}function wr(e,t,r){return e=new e.constructor(t),r&&(e.i=fe),e.o=fe,e}function rt(e,t,r,n){return n??(n=!!(34&t)),e=tt(e,t,Xn,n),n=32,r&&(n|=2),k(e,t=16769217&t|n),e}function nt(e){if(e.i!==fe)return!1;var t=e.m;return ar(t=rt(t,0|t[g]),2048),e.m=t,e.i=void 0,e.o=void 0,!0}function me(e){if(!nt(e)&&z(e,0|e.m[g]))throw Error()}function ge(e,t){t===void 0&&(t=0|e[g]),32&t&&!(4096&t)&&k(e,4096|t)}function br(e,t,r){return!!(2&r)||!(!(32&r)||4096&r)&&(k(t,2|r),e.i=fe,!0)}function D(e,t,r){if((e=ot(e.m,t,void 0,r))!==null)return e}function ot(e,t,r,n){if(t===-1)return null;const o=t+(r?0:-1),i=e.length-1;let s,a;if(!(i<1+(r?0:-1))){if(o>=i)if(s=e[i],s!=null&&typeof s=="object"&&s.constructor===Object)r=s[t],a=!0;else{if(o!==i)return;r=s}else r=e[o];if(n&&r!=null){if((n=n(r))==null)return n;if(!Object.is(n,r))return a?s[t]=n:e[o]=n,n}return r}}function se(e,t,r){me(e),W(e=e.m,0|e[g],t,r)}function W(e,t,r,n,o){const i=r+-1;var s=e.length-1;if(s>=0&&i>=s){const a=e[s];if(a!=null&&typeof a=="object"&&a.constructor===Object)return a[r]=n,t}return i<=s?(e[i]=n,t):(n!==void 0&&(r>=(s=(t??(t=0|e[g]))>>14&1023||536870912)?n!=null&&(e[s+-1]={[r]:n}):e[i]=n),t)}function vr(e,t,r,n,o){let i=e.m,s=0|i[g];n=z(e,s)?1:n,o=!!o||n===3,n===2&&nt(e)&&(i=e.m,s=0|i[g]);let a=(e=Er(i,t))===he?7:0|e[g],l=Ar(a,s);var c=!(4&l);if(c){4&l&&(e=je(e),a=0,l=Be(l,s),s=W(i,s,t,e));let u=0,h=0;for(;u<e.length;u++){const d=r(e[u]);d!=null&&(e[h++]=d)}h<u&&(e.length=h),r=-513&(4|l),l=r&=-1025,l&=-4097}return l!==a&&(k(e,l),2&l&&Object.freeze(e)),Sr(e,l,i,s,t,n,c,o)}function Sr(e,t,r,n,o,i,s,a){let l=t;return i===1||i===4&&(2&t||!(16&t)&&32&n)?it(t)||((t|=!e.length||s&&!(4096&t)||32&n&&!(4096&t||16&t)?2:256)!==l&&k(e,t),Object.freeze(e)):(i===2&&it(t)&&(e=je(e),l=0,t=Be(t,n),n=W(r,n,o,e)),it(t)||(a||(t|=16),t!==l&&k(e,t))),2&t||!(4096&t||16&t)||ge(r,n),e}function Er(e,t,r){return e=ot(e,t,r),Array.isArray(e)?e:he}function Ar(e,t){return 2&t&&(e|=2),1|e}function it(e){return!!(2&e)&&!!(4&e)||!!(256&e)}function Tr(e,t,r){me(e);let n=0|(e=e.m)[g];if(r==null)W(e,n,t);else{var o=r===he?7:0|r[g],i=o,s=it(o),a=s||Object.isFrozen(r);for(s||(o=0),a||(r=je(r),i=0,o=Be(o,n),a=!1),o|=5,o|=(4&o?512&o?512:1024&o?1024:0:void 0)??(Pn?1024:0),s=0;s<r.length;s++){const l=r[s],c=mr(l);Object.is(l,c)||(a&&(r=je(r),i=0,o=Be(o,n),a=!1),r[s]=c)}o!==i&&(a&&(r=je(r),o=Be(o,n)),k(r,o)),W(e,n,t,r)}}function F(e,t,r,n){me(e),W(e=e.m,0|e[g],t,(n==="0"?Number(r)===0:r===n)?void 0:r)}function Ir(e){if(He)return e[ke]??(e[ke]=new Map);if(ke in e)return e[ke];const t=new Map;return Object.defineProperty(e,ke,{value:t}),t}function Lr(e,t,r){var n=yt;let o=e.get(n);if(o!=null)return o;o=0;for(let i=0;i<n.length;i++){const s=n[i];ot(t,s)!=null&&(o!==0&&(r=W(t,r,o)),o=s)}return e.set(n,o),o}function Me(e,t,r){let n=e.m,o=0|n[g];if(t=function(a,l,c,u){let h=!1;if((u=ot(a,u,void 0,d=>{const m=gr(d,c,l);return h=m!==d&&m!=null,m}))!=null)return h&&!z(u)&&ge(a,l),u}(n,o,t,r),t==null)return t;if(o=0|n[g],!z(e,o)){var i,s=t;const a=s.m,l=0|a[g];(i=z(s,l)?br(s,a,l)?wr(s,a,!0):new s.constructor(rt(a,l,!1)):s)!==t&&(nt(e)&&(n=e.m,o=0|n[g]),o=W(n,o,r,t=i),ge(n,o))}return t}function Pr(e){return e==null&&(e=void 0),e}function te(e,t,r){return se(e,t,r=Pr(r)),r&&!z(r)&&ge(e.m),e}function Be(e,t){return-273&(2&t?2|e:-3&e)}function Ce(e,t,r,n){var o=n;me(e);var i=n=e.m,s=0|n[g];const a=z(e,s)?1:2;a===2&&nt(e)&&(s=0|(i=e.m)[g]);let l=(e=Er(i,t))===he?7:0|e[g];var c=Ar(l,s);const u=!(4&c);if(u){var h=e,d=s;const m=!!(2&c);m&&(d|=2);let w=!m,x=!0,_=0,S=0;for(;_<h.length;_++){const P=gr(h[_],r,d);if(P instanceof r){if(!m){const H=z(P);w&&(w=!H),x&&(x=H)}h[S++]=P}}S<_&&(h.length=S),c|=4,c=x?-4097&c:4096|c,c=w?8|c:-9&c}c!==l&&(k(e,c),2&c&&Object.freeze(e)),t=e=Sr(e,c,i,s,t,a,u,!0),o=o??new r,t.push(o),i=r=t===he?7:0|t[g],(o=z(o))?(r&=-9,t.length===1&&(r&=-4097)):r|=4096,r!==i&&k(t,r),o||ge(n)}function U(e,t){return et(D(e,t))??0}function q(e,t,r){F(e,t,It(r),0)}function Ne(e,t,r){if(r!=null){if(typeof r!="number"||!de(r))throw Oe("uint32");r>>>=0}se(e,t,r)}function j(e,t,r){if(r!=null&&typeof r!="string")throw Error();F(e,t,r,"")}function p(e,t,r){if(me(e),t=(e=vr(e,t,Lt,2,!0)).push,typeof r!="string")throw Error();t.call(e,r)}var ye=class{constructor(e,t,r){if(this.buffer=e,r&&!t)throw Error()}};function Or(e){if(typeof e=="string")return new ye(tr(e),!0);if(Array.isArray(e))return new ye(new Uint8Array(e),!0);if(e.constructor===Uint8Array)return new ye(e,!1);if(e.constructor===ArrayBuffer)return e=new Uint8Array(e),new ye(e,!1);if(e.constructor===J){rr(Pe);var t=e.i;return t=((t=t==null||bt(t)?t:typeof t=="string"?tr(t):null)==null?t:e.i=t)||new Uint8Array(0),new ye(t,!0,e)}if(e instanceof Uint8Array)return e=e.constructor===Uint8Array?e:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),new ye(e,!1);throw Error()}function xr(e){return e?/^\d+$/.test(e)?(Xe(e),new Ot(b,E)):null:Qn||(Qn=new Ot(0,0))}var Ot=class{constructor(e,t){this.j=e>>>0,this.i=t>>>0}};let Qn;function kr(e){return e?/^-?\d+$/.test(e)?(Xe(e),new xt(b,E)):null:Zn||(Zn=new xt(0,0))}var xt=class{constructor(e,t){this.j=e>>>0,this.i=t>>>0}};let Zn;function _e(e,t,r){for(;r>0||t>127;)e.i.push(127&t|128),t=(t>>>7|r<<25)>>>0,r>>>=7;e.i.push(t)}function st(e,t){for(;t>127;)e.i.push(127&t|128),t>>>=7;e.i.push(t)}function at(e,t){if(t>=0)st(e,t);else{for(let r=0;r<9;r++)e.i.push(127&t|128),t>>=7;e.i.push(1)}}function lt(e,t){t.length!==0&&(e.l.push(t),e.j+=t.length)}function X(e,t,r){st(e.i,8*t+r)}function ct(e,t){return X(e,t,2),t=e.i.end(),lt(e,t),t.push(e.j),t}function ut(e,t){var r=t.pop();for(r=e.j+e.i.length()-r;r>127;)t.push(127&r|128),r>>>=7,e.j++;t.push(r),e.j++}function ht(e,t,r){X(e,t,2),st(e.i,r.length),lt(e,e.i.end()),lt(e,r)}function K(){const e=class{constructor(){throw Error()}};return Object.setPrototypeOf(e,e.prototype),e}var Re=K(),Ur=K(),ft=K(),dt=K(),eo=K(),to=K(),ro=K(),jr=K(),no=K(),kt=K(),T=class{constructor(e,t){this.m=_r(e,t,void 0,2048)}toJSON(){return yr(this)}};T.prototype[We]=qe,T.prototype.toString=function(){return this.m.toString()};var Y=class{constructor(e,t){this.i=e,e=Re,this.j=!!e&&t===e||!1}};function Mr(e,t,r,n,o){(t=Rr(t,n))!=null&&(r=ct(e,r),o(t,e),ut(e,r))}const oo=new Y(Mr,Re),io=new Y(Mr,Re);var Br=Symbol(),Cr=Symbol();let Nr;function pt(e){var t=so,r=ao,n=e[Br];if(n)return n;(n={}).na=e,n.W=function(u){switch(typeof u){case"boolean":return Yn||(Yn=[0,void 0,!0]);case"number":return u>0?void 0:u===0?Jn||(Jn=[0,void 0]):[-u,void 0];case"string":return[0,u];case"object":return u}}(e[0]);var o=e[1];let i=1;o&&o.constructor===Object&&(n.ca=o,typeof(o=e[++i])=="function"&&(n.ia=!0,Nr??(Nr=e[i+1]),o=e[i+=2]));const s={};for(;o&&Array.isArray(o)&&o.length&&typeof o[0]=="number"&&o[0]>0;){for(var a=0;a<o.length;a++)s[o[a]]=o;o=e[++i]}for(a=1;o!==void 0;){let u;typeof o=="number"&&(a+=o,o=e[++i]);var l=void 0;if(o instanceof Y?u=o:(u=oo,i--),u==null?void 0:u.j){o=e[++i],l=e;var c=i;typeof o=="function"&&(o=o(),l[c]=o),l=o}for(c=a+1,typeof(o=e[++i])=="number"&&o<0&&(c-=o,o=e[++i]);a<c;a++)l?r(n,a,u,l):t(n,a,u)}return e[Br]=n}function Rr(e,t){return e instanceof T?e.m:Array.isArray(e)?_r(e,t[0],t[1]):void 0}function so(e,t,r){e[t]=r.i}function ao(e,t,r,n){let o,i;const s=r.i;e[t]=(a,l,c)=>s(a,l,c,i||(i=pt(n).W),o||(o=Dr(n)))}function Dr(e){let t=e[Cr];if(!t){const r=pt(e);t=(n,o)=>Fr(n,o,r),e[Cr]=t}return t}function Fr(e,t,r){(function(n,o,i){const s=128&o?0:-1,a=n.length;var l;(l=!!a)&&(l=(l=n[a-1])!=null&&typeof l=="object"&&l.constructor===Object);const c=a+(l?-1:0);for(o=128&o?1:0;o<c;o++)i(o-s,n[o]);if(l){n=n[a-1];for(const u in n)!isNaN(u)&&i(+u,n[u])}})(e,0|e[g],(n,o)=>{if(o!=null){var i=function(s,a){var l=s[a];if(l)return l;if((l=s.ca)&&(l=l[a])){var c=(l=Array.isArray(l)?l[0]instanceof Y?l:[io,l]:[l,void 0])[0].i;if(l=l[1]){const u=Dr(l),h=pt(l).W;l=s.ia?Nr(h,u):(d,m,w)=>c(d,m,w,h,u)}else l=c;return s[a]=l}}(r,n);i?i(t,o,n):n<500||$e(Et,3)}})}var Ut,ae=0,we=ae;if(lr(we)){if(!/^\s*(?:-?[1-9]\d*|0)?\s*$/.test(we))throw Error(String(we))}else if((Ut=Rn(we))&&(Ut=!Number.isSafeInteger(we)),Ut)throw Error(String(we));function jt(e,t){if(Array.isArray(t)){var r=0|t[g];if(4&r)return t;for(var n=0,o=0;n<t.length;n++){const i=e(t[n]);i!=null&&(t[o++]=i)}return o<n&&(t.length=o),(e=-1537&(5|r))!==r&&k(t,e),2&e&&Object.freeze(t),t}}function O(e,t){return new Y(e,t)}function Vr(e,t,r){(t=dr(t))!=null&&(X(e,r,5),e=e.i,(r=Hn||(Hn=new DataView(new ArrayBuffer(8)))).setFloat32(0,+t,!0),E=0,t=b=r.getUint32(0,!0),e.i.push(t>>>0&255),e.i.push(t>>>8&255),e.i.push(t>>>16&255),e.i.push(t>>>24&255))}function Mt(e,t,r){(t=pe(t))!=null&&t!=null&&(X(e,r,0),at(e.i,t))}function Gr(e,t,r){(t=ee(t))!=null&&(X(e,r,0),e.i.i.push(t?1:0))}function Bt(e,t,r){(t=Lt(t))!=null&&ht(e,r,qt(t))}function zr(e,t,r,n,o){(t=Rr(t,n))!=null&&(r=ct(e,r),o(t,e),ut(e,r))}function $r(e,t,r){(t=pe(t))!=null&&(t=parseInt(t,10),X(e,r,0),at(e.i,t))}Ye||(ae=Dn(ae)?ae?"1":"0":lr(ae)?ae.trim()||"0":String(ae));var be,mt=O(Vr,jr),Ct=O(Vr,jr),Nt=O(function(e,t,r){if(t=function(n){if(n==null)return n;var o=typeof n;if(o==="bigint")return String(Wn(64,n));if(pr(n)){if(o==="string"){if(o=Ze(Number(n)),Qe(o))n=String(o);else if((o=n.indexOf("."))!==-1&&(n=n.substring(0,o)),o=n.length,!(n[0]==="-"?o<20||o===20&&n<="-9223372036854775808":o<19||o===19&&n<="9223372036854775807"))if(Xe(n),n=b,2147483648&(o=E))if(St())n=""+(BigInt(0|o)<<BigInt(32)|BigInt(n>>>0));else{const[s,a]=At(n,o);n="-"+Je(s,a)}else n=Je(n,o);return n}if(o==="number"){if(n=Ze(n),!Qe(n)){Ue(n),o=b;var i=E;(n=2147483648&i)&&(i=~i>>>0,(o=1+~o>>>0)==0&&(i=i+1>>>0)),n=typeof(o=hr(o,i))=="number"?n?-o:o:n?"-"+o:o}return n}}}(t),t!=null&&(typeof t=="string"&&kr(t),t!=null))switch(X(e,r,0),typeof t){case"number":e=e.i,Ue(t),_e(e,b,E);break;case"bigint":r=BigInt.asUintN(64,t),r=new xt(Number(r&BigInt(4294967295)),Number(r>>BigInt(32))),_e(e.i,r.j,r.i);break;default:r=kr(t),_e(e.i,r.j,r.i)}},to),lo=O(function(e,t,r){if(t=function(n){if(n==null)return n;var o=typeof n;if(o==="bigint")return String(qn(64,n));if(pr(n)){if(o==="string")return o=Ze(Number(n)),Qe(o)&&o>=0?n=String(o):((o=n.indexOf("."))!==-1&&(n=n.substring(0,o)),(o=n[0]!=="-"&&((o=n.length)<20||o===20&&n<="18446744073709551615"))||(Xe(n),n=Je(b,E))),n;if(o==="number")return(n=Ze(n))>=0&&Qe(n)||(Ue(n),n=hr(b,E)),n}}(t),t!=null&&(typeof t=="string"&&xr(t),t!=null))switch(X(e,r,0),typeof t){case"number":e=e.i,Ue(t),_e(e,b,E);break;case"bigint":r=BigInt.asUintN(64,t),r=new Ot(Number(r&BigInt(4294967295)),Number(r>>BigInt(32))),_e(e.i,r.j,r.i);break;default:r=xr(t),_e(e.i,r.j,r.i)}},ro),V=O(Mt,dt);be=new Y(function(e,t,r){if((t=jt(pe,t))!=null&&t.length){r=ct(e,r);for(let n=0;n<t.length;n++)at(e.i,t[n]);ut(e,r)}},dt);var M,y=O(Mt,dt),co=O(Mt,dt),A=O(Gr,Ur),v=O(Gr,Ur),L=O(Bt,ft);M=new Y(function(e,t,r){if((t=jt(Lt,t))!=null)for(let s=0;s<t.length;s++){var n=e,o=r,i=t[s];i!=null&&ht(n,o,qt(i))}},ft);var Rt,C=O(Bt,ft),Hr=O(Bt,ft),$=function(e,t,r=Re){return new Y(t,r)}(0,function(e,t,r,n,o){if(Array.isArray(t)){for(let i=0;i<t.length;i++)zr(e,t[i],r,n,o);1&(e=0|t[g])||k(t,1|e)}}),G=new Y(zr,Re),uo=O(function(e,t,r){(t=et(t))!=null&&t!=null&&(X(e,r,0),st(e.i,t))},eo),re=O($r,kt);Rt=new Y(function(e,t,r){if((t=jt(pe,t))!=null&&t.length){r=ct(e,r);for(let n=0;n<t.length;n++)at(e.i,t[n]);ut(e,r)}},kt);var Q=O($r,kt);function De(e){return function(){const t=new class{constructor(){this.l=[],this.j=0,this.i=new class{constructor(){this.i=[]}length(){return this.i.length}end(){const s=this.i;return this.i=[],s}}}};Fr(this.m,t,pt(e)),lt(t,t.i.end());const r=new Uint8Array(t.j),n=t.l,o=n.length;let i=0;for(let s=0;s<o;s++){const a=n[s];r.set(a,i),i+=a.length}return t.l=[r],r}}function Dt(e,t){if(t!=null)if(Array.isArray(t))se(e,2,tt(t,0,Pt));else{if(!(typeof t=="string"||t instanceof J||bt(t)))throw Error("invalid value in Any.value field: "+t+" expected a ByteString, a base64 encoded string, a Uint8Array or a jspb array");if(t!=null){if(typeof t=="string")t=t?new J(t,Pe):vt();else if(t.constructor!==J){if(!bt(t))throw Error();t=t.length?new J(new Uint8Array(t),Pe):vt()}}F(e,2,t,vt())}}var ve=class extends T{constructor(e){super(e)}},Wr=[0,C,O(function(e,t,r){if(t!=null){if(t instanceof T){const n=t.qa;return void(n?(t=n(t),t!=null&&ht(e,r,Or(t).buffer)):$e(Et,3))}if(Array.isArray(t))return void $e(Et,3)}(t=t==null||typeof t=="string"||t instanceof J?t:void 0)!=null&&ht(e,r,Or(t).buffer)},no)];let Ft,qr=globalThis.trustedTypes;function Kr(e){var t;return Ft===void 0&&(Ft=function(){let r=null;if(!qr)return r;try{const n=o=>o;r=qr.createPolicy("goog#html",{createHTML:n,createScript:n,createScriptURL:n})}catch{}return r}()),e=(t=Ft)?t.createScriptURL(e):e,new class{constructor(r){this.i=r}toString(){return this.i+""}}(e)}function ho(e,...t){if(t.length===0)return Kr(e[0]);let r=e[0];for(let n=0;n<t.length;n++)r+=encodeURIComponent(t[n])+e[n+1];return Kr(r)}var Yr={};Yr[336783863]=[0,L,A,-1,V,[0,[1,2,3,4,5,6,7,8,9],G,[0],G,[0,A,L,A,re,-1,Rt,L,-1,[0,A,-1],re,A,-1],G,[0,L,-2],G,[0,V,A,1,A,-4],G,[0,V,re,A,-1,be,re,-1,A],G,[0,L,-2],G,[0,L,re],G,[0,3,A,-1,2,[0,V],[0,re,A],[0,L,-1],[0]],G,[0,re,-1,A]],[0,L],A,[0,[1,3],[2,4],G,[0,be],-1,G,[0,M],-1,$,[0,L,-1]],L];var Jr=class extends T{constructor(e){super(e)}},Xr=[0,Nt,-1,v,-3,Nt,be,C,y,Nt,-1,v,y,v,-2,C],Z=class extends T{constructor(e){super(e,500)}N(e){return te(this,7,e)}},Fe=[-1,{}],Qr=[0,L,1,Fe],Zr=[0,L,M,Fe];function ne(e,t){Ce(e,1,Z,t)}var en=class extends T{constructor(e){super(e,500)}N(e){return te(this,1001,e)}};en.prototype.j=De([-500,$,[-500,C,-1,M,-3,[-2,Yr,A],$,Wr,y,-1,Qr,Zr,$,[0,C,v],C,Xr,y,M,987,M],4,$,[-500,L,-1,[-1,{}],998,L],$,[-500,L,M,-1,[-2,{},A],997,M,-1],y,$,[-500,L,M,Fe,998,M],M,y,Qr,Zr,$,[0,C,-1,Fe],M,-2,Xr,C,-1,v,[0,v,uo],978,Fe,$,Wr]);var tn=class extends T{constructor(e){super(e)}};let gt;const fo=new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]);async function rn(){if(gt===void 0)try{await WebAssembly.instantiate(fo),gt=!0}catch{gt=!1}return gt}async function Ve(e,t=ho``){const r=await rn()?"wasm_internal":"wasm_nosimd_internal";return{wasmLoaderPath:`${t}/${e}_${r}.js`,wasmBinaryPath:`${t}/${e}_${r}.wasm`}}var le=class{};function nn(e){function t(s,a){return new ReadableStream({start(){},async pull(l){o=o.then(async()=>{if(s.cache.length>0)l.enqueue(s.cache.shift());else{var{value:c,done:u}=await e.read();c&&(a.active&&a.cache.push(c),s.active&&l.enqueue(c)),u&&l.close()}}),await o},cancel(){s.active=!1,s.cache.length=0,a.active||e.cancel()}})}var r={cache:[],active:!0};const n={cache:[],active:!0};let o=Promise.resolve();const i=t(r,n);return r=t(n,r),[i.getReader(),r.getReader()]}async function on(e,t){const r=new Uint8Array(t);let n=0;for(;n<t;){const{value:o,done:i}=await e.read();if(o){const s=o.subarray(0,t-n);r.set(s,n),n+=s.length}if(i)throw Error(`Expected ${t} bytes, but stream ended after reading ${n} bytes.`)}return await e.cancel(),r}le.forVisionTasks=function(e){return Ve("vision",e)},le.forTextTasks=function(e){return Ve("text",e)},le.forGenAiExperimentalTasks=function(e){return Ve("genai_experimental",e)},le.forGenAiTasks=function(e){return Ve("genai",e)},le.forAudioTasks=function(e){return Ve("audio",e)},le.isSimdSupported=function(){return rn()};const po=[[0,async e=>{const t=new TextEncoder().encode("TFL3").length;return e=await on(e,t+4),new TextDecoder("utf-8").decode(e.subarray(4,t+4))==="TFL3"}],[1,async e=>(e=await on(e,6))[4]===80&&e[5]===75]];function mo(){var e=navigator;return typeof OffscreenCanvas<"u"&&(!function(t=navigator){return(t=t.userAgent).includes("Safari")&&!t.includes("Chrome")}(e)||!!((e=e.userAgent.match(/Version\/([\d]+).*Safari/))&&e.length>=1&&Number(e[1])>=17))}async function sn(e){if(typeof importScripts!="function"){const t=document.createElement("script");return t.src=e.toString(),t.crossOrigin="anonymous",new Promise((r,n)=>{t.addEventListener("load",()=>{r()},!1),t.addEventListener("error",o=>{n(o)},!1),document.body.appendChild(t)})}try{importScripts(e.toString())}catch(t){if(!(t instanceof TypeError))throw t;await self.import(e.toString())}}function f(e,t,r){e.o||console.error("No wasm multistream support detected: ensure dependency inclusion of :gl_graph_runner_internal_multi_input target"),r(t=e.h.stringToNewUTF8(t)),e.h._free(t)}function an(e,t,r){e.o||console.error("No wasm multistream support detected: ensure dependency inclusion of :gl_graph_runner_internal_multi_input target");const n=new Uint32Array(t.length);for(let o=0;o<t.length;o++)n[o]=e.h.stringToNewUTF8(t[o]);t=e.h._malloc(4*n.length),e.h.HEAPU32.set(n,t>>2),r(t);for(const o of n)e.h._free(o);e.h._free(t)}function oe(e,t,r){e.h.simpleListeners=e.h.simpleListeners||{},e.h.simpleListeners[t]=r}function ce(e,t,r){let n=[];e.h.simpleListeners=e.h.simpleListeners||{},e.h.simpleListeners[t]=(o,i,s)=>{i?(r(n,s),n=[]):n.push(o)}}const go=(ln=class{constructor(e,t){this.l=!0,this.h=e,this.i=null,this.j=0,this.o=typeof this.h._addIntToInputStream=="function",t!==void 0?this.h.canvas=t:mo()?this.h.canvas=new OffscreenCanvas(1,1):(console.warn("OffscreenCanvas not supported and GraphRunner constructor glCanvas parameter is undefined. Creating backup canvas."),this.h.canvas=document.createElement("canvas"))}async initializeGraph(e){const t=await(await fetch(e)).arrayBuffer();e=!(e.endsWith(".pbtxt")||e.endsWith(".textproto")),this.setGraph(new Uint8Array(t),e)}setGraphFromString(e){this.setGraph(new TextEncoder().encode(e),!1)}setGraph(e,t){const r=e.length,n=this.h._malloc(r);this.h.HEAPU8.set(e,n),t?this.h._changeBinaryGraph(r,n):this.h._changeTextGraph(r,n),this.h._free(n)}configureAudio(e,t,r,n,o){this.h._configureAudio||console.warn('Attempting to use configureAudio without support for input audio. Is build dep ":gl_graph_runner_audio" missing?'),f(this,n||"input_audio",i=>{f(this,o=o||"audio_header",s=>{this.h._configureAudio(i,s,e,t??0,r)})})}setAutoResizeCanvas(e){this.l=e}setAutoRenderToScreen(e){this.h._setAutoRenderToScreen(e)}setGpuBufferVerticalFlip(e){this.h.gpuOriginForWebTexturesIsBottomLeft=e}attachErrorListener(e){this.h.errorListener=e}attachEmptyPacketListener(e,t){this.h.emptyPacketListeners=this.h.emptyPacketListeners||{},this.h.emptyPacketListeners[e]=t}addAudioToStream(e,t,r){this.addAudioToStreamWithShape(e,0,0,t,r)}addAudioToStreamWithShape(e,t,r,n,o){const i=4*e.length;this.j!==i&&(this.i&&this.h._free(this.i),this.i=this.h._malloc(i),this.j=i),this.h.HEAPF32.set(e,this.i/4),f(this,n,s=>{this.h._addAudioToInputStream(this.i,t,r,s,o)})}addGpuBufferToStream(e,t,r){f(this,t,n=>{if(!this.h.canvas)throw Error("No OpenGL canvas configured.");n?this.h._bindTextureToStream(n):this.h._bindTextureToCanvas();const o=this.h.canvas.getContext("webgl2")||this.h.canvas.getContext("webgl");if(!o)throw Error("Failed to obtain WebGL context from the provided canvas. `getContext()` should only be invoked with `webgl` or `webgl2`.");this.h.gpuOriginForWebTexturesIsBottomLeft&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),this.h.gpuOriginForWebTexturesIsBottomLeft&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!1);const[i,s]=e.videoWidth!==void 0?[e.videoWidth,e.videoHeight]:e.naturalWidth!==void 0?[e.naturalWidth,e.naturalHeight]:e.displayWidth!==void 0?[e.displayWidth,e.displayHeight]:[e.width,e.height];!this.l||i===this.h.canvas.width&&s===this.h.canvas.height||(this.h.canvas.width=i,this.h.canvas.height=s);const[a,l]=[i,s];this.h._addBoundTextureToStream(n,a,l,r)})}addBoolToStream(e,t,r){f(this,t,n=>{this.h._addBoolToInputStream(e,n,r)})}addDoubleToStream(e,t,r){f(this,t,n=>{this.h._addDoubleToInputStream(e,n,r)})}addFloatToStream(e,t,r){f(this,t,n=>{this.h._addFloatToInputStream(e,n,r)})}addIntToStream(e,t,r){f(this,t,n=>{this.h._addIntToInputStream(e,n,r)})}addUintToStream(e,t,r){f(this,t,n=>{this.h._addUintToInputStream(e,n,r)})}addStringToStream(e,t,r){f(this,t,n=>{f(this,e,o=>{this.h._addStringToInputStream(o,n,r)})})}addStringRecordToStream(e,t,r){f(this,t,n=>{an(this,Object.keys(e),o=>{an(this,Object.values(e),i=>{this.h._addFlatHashMapToInputStream(o,i,Object.keys(e).length,n,r)})})})}addProtoToStream(e,t,r,n){f(this,r,o=>{f(this,t,i=>{const s=this.h._malloc(e.length);this.h.HEAPU8.set(e,s),this.h._addProtoToInputStream(s,e.length,i,o,n),this.h._free(s)})})}addEmptyPacketToStream(e,t){f(this,e,r=>{this.h._addEmptyPacketToInputStream(r,t)})}addBoolVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateBoolVector(e.length);if(!o)throw Error("Unable to allocate new bool vector on heap.");for(const i of e)this.h._addBoolVectorEntry(o,i);this.h._addBoolVectorToInputStream(o,n,r)})}addDoubleVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateDoubleVector(e.length);if(!o)throw Error("Unable to allocate new double vector on heap.");for(const i of e)this.h._addDoubleVectorEntry(o,i);this.h._addDoubleVectorToInputStream(o,n,r)})}addFloatVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateFloatVector(e.length);if(!o)throw Error("Unable to allocate new float vector on heap.");for(const i of e)this.h._addFloatVectorEntry(o,i);this.h._addFloatVectorToInputStream(o,n,r)})}addIntVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateIntVector(e.length);if(!o)throw Error("Unable to allocate new int vector on heap.");for(const i of e)this.h._addIntVectorEntry(o,i);this.h._addIntVectorToInputStream(o,n,r)})}addUintVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateUintVector(e.length);if(!o)throw Error("Unable to allocate new unsigned int vector on heap.");for(const i of e)this.h._addUintVectorEntry(o,i);this.h._addUintVectorToInputStream(o,n,r)})}addStringVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateStringVector(e.length);if(!o)throw Error("Unable to allocate new string vector on heap.");for(const i of e)f(this,i,s=>{this.h._addStringVectorEntry(o,s)});this.h._addStringVectorToInputStream(o,n,r)})}addBoolToInputSidePacket(e,t){f(this,t,r=>{this.h._addBoolToInputSidePacket(e,r)})}addDoubleToInputSidePacket(e,t){f(this,t,r=>{this.h._addDoubleToInputSidePacket(e,r)})}addFloatToInputSidePacket(e,t){f(this,t,r=>{this.h._addFloatToInputSidePacket(e,r)})}addIntToInputSidePacket(e,t){f(this,t,r=>{this.h._addIntToInputSidePacket(e,r)})}addUintToInputSidePacket(e,t){f(this,t,r=>{this.h._addUintToInputSidePacket(e,r)})}addStringToInputSidePacket(e,t){f(this,t,r=>{f(this,e,n=>{this.h._addStringToInputSidePacket(n,r)})})}addProtoToInputSidePacket(e,t,r){f(this,r,n=>{f(this,t,o=>{const i=this.h._malloc(e.length);this.h.HEAPU8.set(e,i),this.h._addProtoToInputSidePacket(i,e.length,o,n),this.h._free(i)})})}addBoolVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateBoolVector(e.length);if(!n)throw Error("Unable to allocate new bool vector on heap.");for(const o of e)this.h._addBoolVectorEntry(n,o);this.h._addBoolVectorToInputSidePacket(n,r)})}addDoubleVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateDoubleVector(e.length);if(!n)throw Error("Unable to allocate new double vector on heap.");for(const o of e)this.h._addDoubleVectorEntry(n,o);this.h._addDoubleVectorToInputSidePacket(n,r)})}addFloatVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateFloatVector(e.length);if(!n)throw Error("Unable to allocate new float vector on heap.");for(const o of e)this.h._addFloatVectorEntry(n,o);this.h._addFloatVectorToInputSidePacket(n,r)})}addIntVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateIntVector(e.length);if(!n)throw Error("Unable to allocate new int vector on heap.");for(const o of e)this.h._addIntVectorEntry(n,o);this.h._addIntVectorToInputSidePacket(n,r)})}addUintVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateUintVector(e.length);if(!n)throw Error("Unable to allocate new unsigned int vector on heap.");for(const o of e)this.h._addUintVectorEntry(n,o);this.h._addUintVectorToInputSidePacket(n,r)})}addStringVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateStringVector(e.length);if(!n)throw Error("Unable to allocate new string vector on heap.");for(const o of e)f(this,o,i=>{this.h._addStringVectorEntry(n,i)});this.h._addStringVectorToInputSidePacket(n,r)})}attachBoolListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachBoolListener(r)})}attachBoolVectorListener(e,t){ce(this,e,t),f(this,e,r=>{this.h._attachBoolVectorListener(r)})}attachIntListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachIntListener(r)})}attachIntVectorListener(e,t){ce(this,e,t),f(this,e,r=>{this.h._attachIntVectorListener(r)})}attachUintListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachUintListener(r)})}attachUintVectorListener(e,t){ce(this,e,t),f(this,e,r=>{this.h._attachUintVectorListener(r)})}attachDoubleListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachDoubleListener(r)})}attachDoubleVectorListener(e,t){ce(this,e,t),f(this,e,r=>{this.h._attachDoubleVectorListener(r)})}attachFloatListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachFloatListener(r)})}attachFloatVectorListener(e,t){ce(this,e,t),f(this,e,r=>{this.h._attachFloatVectorListener(r)})}attachStringListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachStringListener(r)})}attachStringVectorListener(e,t){ce(this,e,t),f(this,e,r=>{this.h._attachStringVectorListener(r)})}attachProtoListener(e,t,r){oe(this,e,t),f(this,e,n=>{this.h._attachProtoListener(n,r||!1)})}attachProtoVectorListener(e,t,r){ce(this,e,t),f(this,e,n=>{this.h._attachProtoVectorListener(n,r||!1)})}attachAudioListener(e,t,r){this.h._attachAudioListener||console.warn('Attempting to use attachAudioListener without support for output audio. Is build dep ":gl_graph_runner_audio_out" missing?'),oe(this,e,(n,o)=>{n=new Float32Array(n.buffer,n.byteOffset,n.length/4),t(n,o)}),f(this,e,n=>{this.h._attachAudioListener(n,r||!1)})}finishProcessing(){this.h._waitUntilIdle()}closeGraph(){this.h._closeGraph(),this.h.simpleListeners=void 0,this.h.emptyPacketListeners=void 0}},class extends ln{ka(){this.h._registerModelResourcesGraphService()}});var ln;async function yo(e,t){const r=await(async(n,o,i)=>{var s=I;if(n&&await sn(n),!self.ModuleFactory||o&&(await sn(o),!self.ModuleFactory))throw Error("ModuleFactory not set.");return self.Module&&i&&((n=self.Module).locateFile=i.locateFile,i.mainScriptUrlOrBlob&&(n.mainScriptUrlOrBlob=i.mainScriptUrlOrBlob)),i=await self.ModuleFactory(self.Module||i),self.ModuleFactory=self.Module=void 0,new s(i,null)})(e.wasmLoaderPath,e.assetLoaderPath,{locateFile:n=>n.endsWith(".wasm")?e.wasmBinaryPath.toString():e.assetBinaryPath&&n.endsWith(".data")?e.assetBinaryPath.toString():n});return await r.N(t),r}async function Vt(e,t){return yo(e,t)}function cn(e){try{const t=e.J.length;if(t===1)throw Error(e.J[0].message);if(t>1)throw Error("Encountered multiple errors: "+e.J.map(r=>r.message).join(", "))}finally{e.J=[]}}function Se(e,t){e.I=Math.max(e.I,t)}var Gt=class{constructor(e){this.j=e,this.J=[],this.I=0,this.j.setAutoRenderToScreen(!1)}setGraph(e,t){this.j.attachErrorListener((r,n)=>{this.J.push(Error(n))}),this.j.ka(),this.j.setGraph(e,t),cn(this)}finishProcessing(){this.j.finishProcessing(),cn(this)}close(){this.j.closeGraph()}};Gt.prototype.close=Gt.prototype.close;var Ee=class extends T{constructor(e){super(e)}j(){return pe(D(this,2))??0}};function un(e,t){te(e,1,t)}var _o=class extends T{constructor(e){super(e)}},hn=[0,Q,y,Ct,-1,V];function wo(e,t,r,n){if(e.data!==void 0){var o=new Uint8Array(e.data.buffer,t,r);return n===1&&function(i,s,a){i.i.push([s,a]),i.i.sort((l,c)=>l[0]-c[0]),s=0;for(const[l,c]of i.i){const u=c;(a=l)<=s&&(s=Math.max(s,a+u))}s===i.length&&(i.data=void 0)}(e,t,r),o}}Ee.prototype.l=De(hn);class bo{constructor(t){this.i=[],this.data=t,this.length=t.length}}function fn(e,t){return new vo(async()=>{const{value:r,done:n}=await e.read();return n?void 0:r},t)}async function dn(e,t,r,n,o){if(o===2)return e.i=[],e.j=()=>Promise.resolve(void 0),setTimeout(()=>{e.l()},0),Promise.resolve(0);for(;e.size<r+n;){var i=await e.j();if(i===void 0)break;e.i.push(new bo(i))}if(e.size<r+n)throw Error(`Data size is too small: ${e.size}, expected at least ${r+n}.`);i=t._malloc(n)>>>0;let s=0;for(let a=0;a<e.i.length;a++){const l=e.i[a];if(r>=l.length){r-=l.length;continue}const c=Math.min(n,l.length-r);if((r=wo(l,r,c,o))===void 0)throw Error("Data has already been released.");if(t.HEAPU8.set(r,i+s),r=0,s+=c,(n-=c)===0)break}if(n!==0)throw Error("Data not found.");return Promise.resolve(i)}var vo=class{constructor(e,t){this.i=[],this.j=e,this.l=t}get size(){let e=0;for(let t=0;t<this.i.length;t++)e+=this.i[t].length;return e}};function Ge(e){return typeof e=="object"&&e!=null&&"imageSource"in e}function ze(e){return typeof e=="object"&&e!=null&&"audioSource"in e}async function pn(e,t,r){e=new gn(e,r);let n=0;for(t=t.getReader();;){const{value:o,done:i}=await t.read();if(i)break;e.set(o,n),n+=o.byteLength}if(r!==n)throw mn(e),Error(`File could not be fully loaded to memory, so was not retained. Loaded ${n}/${r} bytes before failure`);return e}function mn(e){if(e.i)try{e.h._free(e.j)}catch{}finally{e.i=!1}}var gn=class{constructor(e,t){this.h=e,this.l=t,this.j=this.h._malloc(t)>>>0,this.o=this.h.HEAPU8,this.i=!!this.j}get offset(){if(!this.i)throw Error("WasmFileReference has been freed.");return this.j}get size(){if(!this.i)throw Error("WasmFileReference has been freed.");return this.l}set(e,t){this.o.set(e,this.j+(t??0))}},yn=class extends T{constructor(e){super(e)}};yn.prototype.j=De([0,C,2,M,y,v]);var So=class extends T{constructor(e){super(e)}},Eo=class extends T{constructor(e){super(e)}},Ao=class extends T{constructor(e){super(e)}},_n=class extends T{constructor(e){super(e)}},zt=[0,y,-6,1,y,1,[0,v,Q,-2],[0,v,Ct],Q,-2,[0,v,-1,Q,Ct,re,V,A,-1],1,v,y,V,-1,[0,Q,y],v,-1,mt,y,-5,mt,-1,[0,V,mt],V,A,[0,V,-2],mt,[0,y],[0,y,-4],A,V,-2,A,-1],wn=[0,C,-2],bn=[0,[4,6],zt,y,1,co,M,Hr,Rt,wn,V,[0,[0,y,-1,$,[0,y,[0,y,-1],-1,[0,Q,-1],v],v,-2,y,-1],[0,y,-1,v],zt,v,y,[0,y],-1],L,-3,[0,y,v],zt,[0,wn,-2],be];_n.prototype.j=De([0,C,8,[0,v,-6],1,y,1,y,[0,$,[0,C,lo,-1,Q],bn,y],[0,y,v,-3],1,Q,1,bn,1,y,5,Q,be,1,hn,v,y,v]);var To=class extends T{constructor(e){super(e)}},vn=class extends T{constructor(e){super(e)}},yt=[2,4];vn.prototype.j=De([0,yt,y,Hr,y,G,[0,1,C]]);const Io=function(e){return class extends e{constructor(){super(...arguments),this.P=!1,this.F=this.H=0}M(){if(this.P)throw Error("Cannot process because LLM inference engine is currently loading or processing.");this.P=!0}L(){this.P=!1}async createLlmInferenceEngine(t,r){var n;this.M();try{const o=fn(t,()=>{});await this.h.createLlmInferenceEngine(U(r,2)??512,((n=Me(r,Ee,3))==null?void 0:n.j())??40,ee(D(r,6))??!1??!1,U(r,7)??0,ee(D(r,8))??!1??!1,(i,s,a)=>dn(o,this.h,i,s,a))}finally{this.L()}}async ba(t,r){var n;this.M();try{await this.ma(t),await this.h.ccall("CreateLlmInferenceEngineConverted","void",["number","number","boolean"],[U(r,2)??512,((n=Me(r,Ee,3))==null?void 0:n.j())??40,ee(D(r,6))??!1??!1],{async:!0})}finally{this.L()}}V(){this.M();try{const t=this.h;t.ccall("DeleteLlmInferenceEngine","void",[],[],{async:!1}),this.H&&(t._FreeSession(this.H),this.F===this.H&&(this.F=0),this.H=0),this.F&&(t._FreeSession(this.F),this.F=0)}finally{this.L()}}async R(t,r,n){this.M();try{const o=[],i=this.h;i._userProgressListener=(d,m)=>{d&&o.push(d),n&&n(d,m)};const s=r.l(),a=s.length,l=this.h._malloc(a);this.h.HEAPU8.set(s,l);const c=t.some(ze),u=t.some(Ge);i.ccallNum=i.ccall;const h=await i.ccallNum("MakeSessionForPredict","number",["number","number","boolean","boolean"],[l,a,u,c],{async:!0});r=[];for(const d of t)if(typeof d=="string")f(this,d,m=>{i._AddTextQueryChunk(h,m)});else if(Ge(d)){const{image:m,width:w,height:x}=await this.fa(d.imageSource),_=typeof OffscreenCanvas<"u"?new OffscreenCanvas(w,x):document.createElement("canvas");_.width=w,_.height=x;const S=_.getContext("2d");S.drawImage(m,0,0);const P=S.getImageData(0,0,w,x),H=this.h._malloc(P.width*P.height*4);this.h.HEAPU8.set(P.data,H),i._AddImageQueryChunk(h,H,P.width,P.height),r.push(H)}else{if(!ze(d))throw Error("Unsupported PromptPart type in query.");{const m=await this.ea(d.audioSource),w=this.h._malloc(m.audioSamples.byteLength);this.h.HEAPF32.set(m.audioSamples,w/4),i._AddAudioQueryChunk(h,m.audioSampleRateHz,w,m.audioSamples.length),r.push(w)}}await i.ccall("PredictSession","void",["number"],[h],{async:!0}),t=!0,u&&this.F===0&&(this.F=h,t=!1),c&&this.H===0&&(this.H=h,t=!1),t&&i._FreeSession(h);for(const d of r)this.h._free(d);return r.length=0,n&&n("",!0),this.h._free(l),i._userProgressListener=void 0,o.join("")}finally{this.L()}}S(t){this.M();let r=0,n="";for(const o of t)typeof o=="string"?n+=o:Ge(o)?r+=260:ze(o)&&console.warn("sizeInTokens is not yet implemented for audio; audio tokens will not be counted");try{let o;return f(this,n,i=>{o=this.h._GetSizeInTokens(i)}),r+o}finally{this.L()}}async ma(t){t=await async function(r){const n=[];for(var o=0;;){const{done:i,value:s}=await r.read();if(i)break;n.push(s),o+=s.length}if(n.length===0)return new Uint8Array(0);if(n.length===1)return n[0];r=new Uint8Array(o),o=0;for(const i of n)r.set(i,o),o+=i.length;return r}(t);try{this.h.FS_unlink("llm.task")}catch{}this.h.FS_createDataFile("/","llm.task",t,!0,!1,!1)}async fa(t){if(typeof t=="string"){const r=new Image;r.src=t,r.crossOrigin="Anonymous";try{await r.decode()}catch{throw Error(`Image from URL ${t} failed to load`)}return{image:r,width:r.naturalWidth,height:r.naturalHeight}}if(t instanceof HTMLImageElement){try{await t.decode()}catch{throw Error("Image from HTMLImageElement failed to load")}return{image:t,width:t.naturalWidth,height:t.naturalHeight}}return t instanceof HTMLVideoElement?{image:t,width:t.videoWidth,height:t.videoHeight}:t instanceof VideoFrame?{image:t,width:t.displayWidth,height:t.displayHeight}:{image:t,width:t.width,height:t.height}}async ea(t){if(typeof t=="string"){const r=await fetch(t);if(!r.ok)throw Error(`Audio fetch for ${t} had error: ${r.status}`);return t=await r.arrayBuffer(),{audioSamples:(t=await new AudioContext({sampleRate:16e3}).decodeAudioData(t)).getChannelData(0),audioSampleRateHz:t.sampleRate}}return typeof t=="object"&&t!=null&&"audioSamples"in t&&"audioSampleRateHz"in t?t:{audioSamples:t.getChannelData(0),audioSampleRateHz:t.sampleRate}}}}(function(e){const t=class extends e{static async la(r,n){let o;n||(n=await t.X());const i=[];for(const s of(r==null?void 0:r.requiredFeatures)??[])n.features.has(s)?i.push(s):console.warn(`WebGPU feature ${s} is not supported.`);r={...r,requiredFeatures:i};try{o=await n.requestDevice(r)}catch(s){throw console.error("Unable to initialize WebGPU with the requested features."),s}return(r=o).adapterInfo||(r.adapterInfo=n.info),o}static async X(r){if(!(r=await navigator.gpu.requestAdapter(r)))throw Error("Unable to request adapter from navigator.gpu; Ensure WebGPU is enabled.");return r}ga(r){if(n)typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement&&(n.id="canvas_webgpu");else var n=new OffscreenCanvas(1,1);n.getContext("webgpu").configure({device:r,format:navigator.gpu.getPreferredCanvasFormat()}),this.h.preinitializedWebGPUDevice=r}aa(){return this.h.ccall("closeGraph","void",[],[],{async:!0})}};return t}(function(e){return class extends e{addStreamingReaderToInputSidePacket(t,r){this.h.addStreamingReaderToInputSidePacket((n,o,i)=>dn(t,this.h,n,o,i),r)}}}(function(e){return class extends e{Y(t,r){f(this,"lora_model_ref_in",n=>{this.h._addRawDataSpanToInputStream(t.offset,t.size,n,r)})}}}(class extends go{}))));class $t extends Io{}var Ht=class{constructor(e){this.j=e,this.i=Sn,Sn++}},Sn=1;class Lo{constructor(){let t,r;this.promise=new Promise((n,o)=>{t=n,r=o}),this.resolve=t,this.reject=r}}function En(e){return e===1?1:e+e%2}async function _t(){const e=await $t.X({powerPreference:"high-performance"});var t=e.limits.maxBufferSize,r=e.limits.maxStorageBufferBindingSize;return t<524550144&&console.warn(`This WebGPU device is unable to execute most LLM tasks, because the required maxBufferSize is usually at least 524550144, but your device only supports maxBufferSize of ${t}`),r<524550144&&console.warn(`The WebGPU device is unable to execute LLM tasks, because the required maxStorageBufferBindingSize is usually at least 524550144, but your device only supports maxStorageBufferBindingSize of ${r}`),t={requiredFeatures:["shader-f16"],requiredLimits:{maxStorageBufferBindingSize:r,maxBufferSize:t,maxStorageBuffersPerShaderStage:e.limits.maxStorageBuffersPerShaderStage}},e.features.has("subgroups")&&(console.warn("Experimental Chromium WGSL subgroup support detected. Enabling this feature in the inference engine."),r=["shader-f16","subgroups"],e.features.has("subgroups-f16")&&r.push("subgroups-f16"),t.requiredFeatures=r),$t.la(t,e)}function Ae(e){if(e.D.length>0){const t=[...e.D];if(e.D.length=0,!e.o)throw t;e.o.reject(t),e.o=void 0}}function Po(e){var n;const t=function(o){const i=new en;p(i,10,"text_in"),p(i,10,"token_cost_in"),p(i,10,"lora_model_id_to_apply_in"),p(i,10,"lora_model_ref_in"),p(i,10,"lora_model_id_to_load_in"),p(i,16,"streaming_reader"),p(i,15,"text_out"),p(i,15,"text_end"),p(i,15,"token_cost_out");var s=new Z;j(s,2,"TokenizerInputBuildCalculator"),p(s,3,"PROMPT:text_in"),p(s,3,"LORA_ID:lora_model_id_to_apply_in"),p(s,4,"prompt"),ne(i,s),j(s=new Z,2,"ModelDataCalculator"),p(s,6,"MODEL_DATA:__side_packet_1"),p(s,6,"MODEL_TYPE:model_type"),p(s,5,"READ_DATA_FN:streaming_reader"),p(s,3,"LORA_MODEL_SPAN:lora_model_ref_in"),p(s,3,"LORA_MODEL_ID:lora_model_id_to_load_in"),p(s,4,"LORA_DATA:lora_model_data"),ne(i,s),j(s=new Z,2,"Gpt2UnicodeMappingCalculator"),p(s,5,"MODEL_TYPE:model_type"),p(s,6,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),ne(i,s),j(s=new ve,1,"type.googleapis.com/odml.infra.proto.TokenizerCalculatorOptions");var a=new vn,l=U(o.i,2);q(a,1,l),j(l=new To,2,"spm_vocab_model"),l=Pr(l);e:{me(a);var c=a.m,u=0|c[g];if(l==null){var h=Ir(c);if(Lr(h,c,u)!==4)break e;h.set(yt,0)}else{const d=Ir(h=c),m=Lr(d,h,u);m!==4&&(m&&(u=W(h,u,m)),d.set(yt,4))}W(c,u,4,l)}return l&&!z(l)&&ge(a.m),q(a,3,2),Dt(s,a.j()),j(a=new Z,2,"TokenizerCalculator"),Ce(a,8,ve,s),p(a,5,"MODEL_DATA:__side_packet_1"),p(a,3,"PROMPT_AND_INPUT_OPTIONS:prompt"),p(a,5,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),p(a,6,"PROCESSOR_GETTER:__input_side_1"),p(a,4,"IDS_AND_INPUT_OPTIONS:__stream_0"),ne(i,a),j(s=new ve,1,"type.googleapis.com/odml.infra.proto.LlmGpuCalculatorOptions"),q(a=new _n,12,3),j(a,1,"llm.tflite"),q(a,14,0),l=En(U(o.i,5)),q(a,22,l),l=Me(o.i,Ee,3),te(a,31,l),F(l=new So,1,ie(!0),!1),ee(D(o.i,6))!=null&&(ee(D(o.i,6))??!1)&&F(l,1,ie(!1),!1),F(l,2,ie(!0),!1),F(l,5,ie(!0),!1),te(a,10,l),l=vr(o.i,4,pe,Nn===void 0?2:4),Tr(a,29,l),l=new Ao,q(c=new Eo,1,1),h=U(o.i,2),q(c,2,h),te(l,1,c),te(a,20,l),Dt(s,a.j()),j(a=new Z,2,"LlmGpuCalculator"),Ce(a,8,ve,s),p(a,3,"IDS_AND_INPUT_OPTIONS:__stream_0"),p(a,3,"FINISH:finish"),p(a,3,"LORA_DATA:lora_model_data"),p(a,5,"MODEL_DATA:__side_packet_1"),p(a,4,"DECODED_IDS:__stream_3"),p(a,4,"OUTPUT_END:__stream_4"),j(s=new Jr,1,"FINISH"),F(s,2,ie(!0),!1),Ce(a,13,Jr,s),ne(i,a),j(s=new Z,2,"IsPacketPresentCalculator"),p(s,3,"__stream_4"),p(s,4,"text_end"),ne(i,s),j(s=new ve,1,"type.googleapis.com/odml.infra.proto.DetokenizerCalculatorOptions"),a=new yn,o=En(U(o.i,5)),q(a,5,o),p(a,4,"<eos>"),p(a,4,"<|endoftext|>"),Dt(s,a.j()),j(o=new Z,2,"DetokenizerCalculator"),Ce(o,8,ve,s),p(o,3,"IDS_AND_INPUT_OPTIONS:__stream_3"),p(o,5,"PROCESSOR_GETTER:__input_side_1"),p(o,5,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),p(o,5,"MODEL_DATA:__side_packet_1"),p(o,4,"FINISH_AND_INPUT_OPTIONS:finish"),p(o,4,"WORDS:text_out"),ne(i,o),j(o=new Z,2,"TokenCostCalculator"),p(o,3,"PROMPT:token_cost_in"),p(o,5,"PROCESSOR_GETTER:__input_side_1"),p(o,5,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),p(o,4,"NUM_TOKENS:token_cost_out"),ne(i,o),i}(e);e.j.attachStringVectorListener("text_out",(o,i)=>{o=function(s,a){return s==null||s.length===0?[]:s.map(l=>(l=(l=l.replaceAll("‚ñÅ"," ")).replaceAll("<0x0A>",`
`),a&&(l=l.trimStart()),l.split("\\[eod\\]",1)[0]))}(o,e.G.length===0),o.forEach((s,a)=>{a<U(e.i,5)&&e.G[a].push(s)}),e.A&&e.D.length===0&&(e.B?(o.length>U(e.i,5)&&o.pop(),e.A(o,!1)):e.A(o[0],!1)),Se(e,i)}),e.j.attachEmptyPacketListener("text_out",o=>{Se(e,o)}),e.j.attachBoolListener("text_end",(o,i)=>{Se(e,i);try{Ae(e)}catch(s){throw e.l=!1,s}if(e.o&&(e.o.resolve(e.G.map(s=>s.join(""))),e.o=void 0),e.A)if(e.B){for(o=[],i=0;i<U(e.i,5);i++)o.push("");e.A(o,!0)}else e.A("",!0);e.l=!1,e.B=void 0}),e.j.attachEmptyPacketListener("text_end",o=>{e.l=!1,e.B=void 0,Se(e,o),Ae(e),e.o&&(e.o.resolve(e.G.map(i=>i.join(""))),e.o=void 0)}),e.j.attachIntListener("token_cost_out",(o,i)=>{e.T=o,Se(e,i)}),e.U&&e.j.addStreamingReaderToInputSidePacket(e.U,"streaming_reader");const r=t.j();return(n=e.C)==null||n.removeEventListener("uncapturederror",e.K),e.j.aa().then(()=>{var o;(o=e.C)==null||o.addEventListener("uncapturederror",e.K),e.D.length=0,e.setGraph(new Uint8Array(r),!0),e.finishProcessing()})}function An(e,t,r,n){if(e.A=typeof r=="function"?r:n,(n=(t=Array.isArray(t)?t:[t]).filter(o=>Ge(o)).length)>0&&(et(D(e.i,7))==null||U(e.i,7)<n))throw Error(`maxNumImages is set to ${et(D(e.i,7))!=null?U(e.i,7):0}, but the query included ${n} images.`);if((n=t.filter(o=>ze(o)).length)>0&&(ee(D(e.i,8))==null||!ee(D(e.i,8))))throw Error(`supportAudio was not enabled, but the query included ${n} audio chunks.`);if(e.v){if(e.B&&U(e.i,5)>1)throw Error("Multi-response generation is not supported for converted LLM models (.task format) yet, nor is it supported for multimodality. Please use the .bin format without multimodality or request only one response.");if(r instanceof Ht)throw Error("LoRA is not supported for converted LLM models (.task format) yet, nor is it supported for multimodality. Please use the .bin format without multimodality to use LoRA.");return e.j.h.LLM_CANCEL_FLAG=void 0,e.j.R(t,e.u,(o,i)=>{e.D.length===0&&e.A&&(e.B?e.A([o],i):e.A(o,i))}).then(o=>(Ae(e),[o]))}if(e.l)throw Error("Previous invocation or loading is still ongoing.");for(e.l=!0,e.j.h.LLM_CANCEL_FLAG=void 0,e.G.length=0,n=0;n<U(e.i,5);n++)e.G[n]=[];if(n=e.I+1,e.j.addStringToStream(t.join(""),"text_in",n),r instanceof Ht){if(r.j!==e)throw e.l=!1,e.B=void 0,Error("The LoRA model was not loaded by this LLM Inference task.");e.j.addUintToStream(r.i,"lora_model_id_to_apply_in",n)}else e.j.addEmptyPacketToStream("lora_model_id_to_apply_in",n);return e.finishProcessing(),e.o=new Lo,e.o.promise}var I=class extends Gt{constructor(e,t){if(super(new $t(e,t)),this.G=[],this.O=this.v=this.l=!1,this.D=[],this.K=r=>{if((r=r.error).message.match(/exceeds the max buffer size limit/))throw Error(`Failed to run this LLM model because it requires a buffer size that exceeds the maximum size your device supports, but you could try a smaller LLM model or different device.
WebGPU throws: "${r.message}"`);if(r.message.match(/is larger than the maximum storage buffer binding size/))throw Error(`Failed to run this LLM model because it requires a storage buffer binding size that exceeds the maximum size your device supports, but you could try a smaller LLM model or different device.
WebGPU throws: "${r.message}"`);this.D.push(r)},this.i=new _o,un(this.i,new tn),this.u=new Ee,te(this.i,3,this.u),Ne(this.i,2,512),e=this.u,!de(2))throw Oe("enum");F(e,1,2,0),q(this.u,2,40),F(this.u,3,Tt(1),0),se(this.u,5,It(0)),F(this.u,4,Tt(.8),0),Ne(this.i,5,1)}async N(e){var s,a,l,c,u,h,d;if(this.l)throw Error("Cannot set options while loading or processing.");if((s=e.baseOptions)!=null&&s.modelAssetPath&&((a=e.baseOptions)!=null&&a.modelAssetBuffer))throw Error("Cannot set both baseOptions.modelAssetPath and baseOptions.modelAssetBuffer");let t;const r=new Promise(m=>{t=m});if((l=e.baseOptions)!=null&&l.modelAssetPath){var n=await fetch(e.baseOptions.modelAssetPath.toString());if(!n.ok)throw Error(`Failed to fetch model: ${e.baseOptions.modelAssetPath} (${n.status})`);if(!n.body)throw Error(`Failed to fetch model: ${e.baseOptions.modelAssetPath} (no body)`);n=n.body.getReader()}else((c=e.baseOptions)==null?void 0:c.modelAssetBuffer)instanceof Uint8Array?n=function(m){return new ReadableStream({start(){},async pull(w){w.enqueue(m),w.close()}})}(e.baseOptions.modelAssetBuffer).getReader():((u=e.baseOptions)==null?void 0:u.modelAssetBuffer)instanceof ReadableStreamDefaultReader?(n=e.baseOptions.modelAssetBuffer,e.baseOptions.modelAssetBuffer=void 0):t();if(!n)throw Error("No model asset provided.");{const[m,w]=nn(n);this.O=await async function(x){const _=[];let S;for(const[H,Wt]of po){const Mo=H;var P=Wt;[x,S]=nn(x),P=await P(S),await S.cancel(),P&&_.push(Mo)}if(await x.cancel(),_.length===0)throw Error("No model format matched.");if(_.length===1)return _[0];throw Error(`Multiple model formats matched: ${_}`)}(w)===1;var o="maxNumImages"in e&&e.maxNumImages?e.maxNumImages:0;Ne(this.i,7,o);var i="supportAudio"in e&&!!e.supportAudio;se(this.i,8,ie(i)),this.O||o>0||i?(this.v=!0,n=m):(this.v=!1,this.U=fn(m,t))}if((d=(h=e.baseOptions)==null?void 0:h.gpuOptions)!=null&&d.device&&(this.C&&this.C.removeEventListener("uncapturederror",this.K),this.C=e.baseOptions.gpuOptions.device,this.j.ga(this.C),this.C.addEventListener("uncapturederror",this.K)),"maxTokens"in e&&Ne(this.i,2,e.maxTokens??512),"topK"in e&&q(this.u,2,e.topK??40),"temperature"in e&&F(this.u,4,Tt(e.temperature??.8),0),"randomSeed"in e&&se(this.u,5,It(e.randomSeed??0)),"loraRanks"in e&&function(m,w){Tr(m,4,w)}(this.i,e.loraRanks??[]),"numResponses"in e){if((o=e.numResponses??1)<1)throw Error("'numResponses' must be at least 1.");if(this.v&&o>1)throw Error("'numResponses > 1' is not supported for converted LLM models yet, and is also not supported with multimodality.");Ne(this.i,5,o),i=Me(this.i,Ee,3),o>1&&i&&(i.j()<=1||(D(i,4,dr)??0)<=0)&&console.warn("To generate multiple responses, it is expected topK > 1 and temperature > 0; otherwise, all the generated responses may be the same.")}return"forceF32"in e&&e.forceF32!==void 0&&se(this.i,6,ie(e.forceF32)),this.v?(this.j.V(),this.O?this.j.ba(n,this.i).then(()=>{Ae(this)}):this.j.createLlmInferenceEngine(n,this.i).then(()=>{Ae(this)})):(this.l=!0,e=Po(this).then(()=>{}),Promise.all([r,e]).then(()=>{this.l=!1,Ae(this)}))}get baseOptions(){return Me(this.i,tn,1)}set baseOptions(e){un(this.i,e)}get isIdle(){return!this.l&&!this.o}R(e,t,r){return U(this.i,5)>1&&console.warn("'numResponses' is set larger than 1 and this function only returns the first response, so we recommend either using 'generateResponses()' to obtain multiple responses, or else setting 'numResponses' to 1 for better performance."),this.B=!1,An(this,e,t,r).then(n=>n[0])}da(e,t,r){return this.B=!0,An(this,e,t,r)}S(e){if(e=Array.isArray(e)?e:[e],this.v)return this.j.S(e);if(this.l)throw Error("Previous invocation or loading is still ongoing.");if(e.some(Ge))throw Error("sizeInTokens requires maxNumImages > 0 for images.");if(e.some(ze))throw Error("sizeInTokens requires supportAudio for audio.");return e=e.join(""),this.l=!0,this.T=void 0,this.j.addStringToStream(e,"token_cost_in",this.I+1),this.finishProcessing(),this.l=!1,this.T}Z(){const e=this.j.h;(this.v||this.l)&&(e.LLM_CANCEL_FLAG=1)}async ja(e){if(this.v)throw Error("LoRA is not supported for converted LLM models (.task format) yet, nor is it supported for multimodality. Please use the old format (.bin) without multimodality to use LoRA.");if(this.l)throw Error("Cannot load LoRA model while loading or processing.");if(this.l=!0,e instanceof Uint8Array){var t=new gn(this.j.h,e.length);t.set(e),e=t}else e=e instanceof Blob?await async function(n,o){return pn(n,o.stream(),o.size)}(this.j.h,e):await async function(n,o){o=await fetch(o.toString());const i=Number(o.headers.get("content-length"));if(!o.body)throw Error("Response body is not available.");if(!i)throw Error("File size is 0.");return pn(n,o.body,i)}(this.j.h,e);t=new Ht(this);const r=this.I+1;return this.j.Y(e,r),this.j.addUintToStream(t.i,"lora_model_id_to_load_in",r),this.finishProcessing(),mn(e),Se(this,r),this.l=!1,t}close(){var e;this.v&&this.j.V(),(e=this.C)==null||e.removeEventListener("uncapturederror",this.K),super.close()}};if(I.prototype.loadLoraModel=I.prototype.ja,I.prototype.cancelProcessing=I.prototype.Z,I.prototype.sizeInTokens=I.prototype.S,I.prototype.generateResponses=I.prototype.da,I.prototype.generateResponse=I.prototype.R,I.prototype.setOptions=I.prototype.N,I.createWebGpuDevice=_t,I.createFromModelPath=async function(e,t){return Vt(e,t={baseOptions:{gpuOptions:{device:await _t()},modelAssetPath:t}})},I.createFromModelBuffer=async function(e,t){return Vt(e,t={baseOptions:{gpuOptions:{device:await _t()},modelAssetBuffer:t}})},I.createFromOptions=async function(e,t){var r,n,o;if(!((n=(r=t.baseOptions)==null?void 0:r.gpuOptions)!=null&&n.device)){const i=await _t();t.baseOptions=t.baseOptions??{},t.baseOptions.gpuOptions=((o=t==null?void 0:t.baseOptions)==null?void 0:o.gpuOptions)??{},t.baseOptions.gpuOptions.device=i}return Vt(e,t)},self.exports={},typeof self.HTMLImageElement>"u"&&(self.HTMLImageElement=class{}),typeof self.Image>"u"&&(self.Image=self.HTMLImageElement),typeof self.HTMLVideoElement>"u"&&(self.HTMLVideoElement=class{}),typeof self.AudioContext>"u"){const e=(r,n,o)=>{let i="";for(let s=0;s<o;s++)i+=String.fromCharCode(r.getUint8(n+s));return i};class t{constructor(n){Ie(this,"sampleRate");Ie(this,"length");Ie(this,"duration");Ie(this,"numberOfChannels");Ie(this,"channels");var o;this.sampleRate=n.sampleRate,this.numberOfChannels=n.numberOfChannels,this.channels=n.pcmData,this.length=((o=this.channels[0])==null?void 0:o.length)||0,this.duration=this.length/this.sampleRate}getChannelData(n){if(n>=this.numberOfChannels)throw new Error(`Invalid channel index ${n}.`);return this.channels[n]}}self.AudioContext=class{decodeAudioData(n){return new Promise((o,i)=>{try{const s=new DataView(n);if(e(s,0,4)!=="RIFF"||e(s,8,4)!=="WAVE")return i(new DOMException("Invalid WAV file header","DataCloneError"));let a=-1,l=-1,c=0,u=12;for(;u<s.byteLength;){const _=e(s,u,4),S=s.getUint32(u+4,!0);_==="fmt "?a=u+8:_==="data"&&(l=u+8,c=S),u+=8+S}if(a===-1||l===-1)return i(new DOMException("Could not find fmt and data chunks in WAV file","DataCloneError"));const h=s.getUint16(a+2,!0),d=s.getUint32(a+4,!0),m=s.getUint16(a+14,!0);if(m!==16)return i(new DOMException(`Unsupported bitsPerSample: ${m}. Only 16-bit PCM is supported.`,"NotSupportedError"));const w=Array.from({length:h},()=>new Float32Array(c/(h*(m/8)))),x=c/(m/8);for(let _=0;_<x;_++){const S=l+_*(m/8),P=_%h,H=Math.floor(_/h),Wt=s.getInt16(S,!0);w[P][H]=Wt/32768}o(new t({sampleRate:d,numberOfChannels:h,pcmData:w}))}catch(s){i(s)}})}}}typeof self.OfflineAudioContext>"u"&&(self.OfflineAudioContext=self.AudioContext);const Oo="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-genai@0.10.25/wasm";let B=null,Te=null;const xo=async e=>{const{modelBlob:t,modelSource:r,options:n}=e;B&&(await B.close(),B=null);try{if(!("gpu"in navigator))throw new Error("WebGPU is not supported.");if(!t)throw new Error(`Model data for ${r} not found.`);const o=URL.createObjectURL(t),i=await le.forGenAiTasks(Oo),{maxTokens:s=2048,topK:a=40,temperature:l=.3,randomSeed:c=10,supportAudio:u=!1,maxNumImages:h=0}=n;B=await I.createFromOptions(i,{baseOptions:{modelAssetPath:o,delegate:"GPU"},maxTokens:s,topK:a,temperature:l,randomSeed:c,supportAudio:u,maxNumImages:h}),URL.revokeObjectURL(o),self.postMessage({type:"init_done",payload:{modelIdentifier:r}})}catch(o){B=null;const i=o instanceof Error?o.message:"Unknown initialization error.";self.postMessage({type:"init_error",payload:{error:i}})}},ko=async()=>{B&&(console.log("Unloading offline model from inference worker..."),await B.close(),B=null,console.log("Offline model unloaded successfully.")),self.postMessage({type:"unload_done"})},Tn=(e,t,r,n)=>{if(!B)throw new Error("Offline model is not initialized.");Te=new AbortController;const o=Te.signal;return new Promise((i,s)=>{const a=()=>s(new DOMException("Translation cancelled.","AbortError"));o.addEventListener("abort",a,{once:!0});const l=performance.now();let c=null,u=null;try{let h="";const d=(x,_)=>{if(!o.aborted){if(c===null&&x){const S=performance.now();c=S-l,u=S}if(h+=x,n&&self.postMessage({type:"translation_chunk",payload:{chunk:x}}),_){const S=performance.now();if(u){const P=S-u,H=h.length/(P/1e3)}else c&&console.log(`[Perf] Single-chunk response received in ${c.toFixed(2)} ms.`);o.removeEventListener("abort",a),i(h.trim())}}},w=`Translate the following ${t==="Auto Detect"?"auto-detect the source language":`from ${t}`} text into concise ${r}: "${e}". 
 Provide *only* the translated text. Do not include any additional explanations, commentary, or greetings.`;B.generateResponse(w,d)}catch(h){o.removeEventListener("abort",a),s(h)}})},Uo=async e=>{if(!B)return self.postMessage({type:"extract_text_error",payload:{error:"Offline model not initialized."}});const{imageBitmap:t}=e,r="Extract all text from the following image. Return only the extracted text without any extra comments or explanations.";try{const n=await B.generateResponse([`<start_of_turn>user
${r}
`,{imageSource:t},`<end_of_turn>
<start_of_turn>model
`]);t.close(),self.postMessage({type:"extract_text_done",payload:{text:n.trim()}})}catch(n){console.error("OCR Worker Error:",n);const o=n instanceof Error?n.message:"Offline image text extraction failed.";self.postMessage({type:"extract_text_error",payload:{error:o}})}},jo=async e=>{if(!B)return self.postMessage({type:"transcribe_error",payload:{error:"Offline model not initialized."}});const{audioData:t,sourceLang:r}=e;let n=null;try{n=URL.createObjectURL(t);const i=`Transcribe the following audio. ${r==="Auto Detect"?"Auto-detect the language.":`The language is ${r}.`}  Return only the transcribed text.`,s=await B.generateResponse([`<start_of_turn>user
 ${i} <end_of_turn>
<start_of_turn>model
`,{audioSource:n}]);(!s||s.trim()==="")&&console.warn("Model returned an empty response for transcription."),self.postMessage({type:"transcribe_done",payload:{text:s.trim()}})}catch(o){console.error("Transcription Internal Error:",o);const i=o instanceof Error?o.message:"Offline audio transcription failed.";self.postMessage({type:"transcribe_error",payload:{error:i}})}finally{n&&URL.revokeObjectURL(n)}};self.onmessage=async e=>{const{type:t,payload:r}=e.data;try{switch(t){case"init":await xo(r);break;case"unload":await ko();break;case"translate_stream":{const n=await Tn(r.text,r.sourceLang,r.targetLang,!0);self.postMessage({type:"translation_done",payload:{result:n}});break}case"translate_full":{const n=await Tn(r.text,r.sourceLang,r.targetLang,!1);self.postMessage({type:"translation_full_done",payload:{result:n}});break}case"cancel_task":Te==null||Te.abort();break;case"extractText":await Uo(r);break;case"transcribe":await jo(r);break;default:console.warn(`Unknown inference worker message type: ${t}`)}}catch(n){const o=n instanceof DOMException&&n.name==="AbortError",i=t.replace("_stream","").replace("_full","");if(o)self.postMessage({type:"translation_cancelled"});else{const s=n instanceof Error?n.message:`Unknown error in ${t}.`;self.postMessage({type:`${i}_error`,payload:{error:s}})}}finally{Te=null}}})();
