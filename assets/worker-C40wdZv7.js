var T=Object.defineProperty;var D=(m,f,y)=>f in m?T(m,f,{enumerable:!0,configurable:!0,writable:!0,value:y}):m[f]=y;var x=(m,f,y)=>D(m,typeof f!="symbol"?f+"":f,y);(function(){"use strict";if(typeof self.HTMLImageElement>"u"&&(self.HTMLImageElement=class{}),typeof self.Image>"u"&&(self.Image=self.HTMLImageElement),typeof self.HTMLVideoElement>"u"&&(self.HTMLVideoElement=class{}),typeof self.AudioContext>"u"){const s=(r,e,t)=>{let o="";for(let n=0;n<t;n++)o+=String.fromCharCode(r.getUint8(e+n));return o};class a{constructor(e){x(this,"sampleRate");x(this,"length");x(this,"duration");x(this,"numberOfChannels");x(this,"channels");var t;this.sampleRate=e.sampleRate,this.numberOfChannels=e.numberOfChannels,this.channels=e.pcmData,this.length=((t=this.channels[0])==null?void 0:t.length)||0,this.duration=this.length/this.sampleRate}getChannelData(e){if(e>=this.numberOfChannels)throw new Error(`Invalid channel index ${e}.`);return this.channels[e]}}self.AudioContext=class{decodeAudioData(e){return new Promise((t,o)=>{try{const n=new DataView(e);if(s(n,0,4)!=="RIFF"||s(n,8,4)!=="WAVE")return o(new DOMException("Invalid WAV file header","DataCloneError"));let i=-1,c=-1,g=0,d=12;for(;d<n.byteLength;){const p=s(n,d,4),_=n.getUint32(d+4,!0);p==="fmt "?i=d+8:p==="data"&&(c=d+8,g=_),d+=8+_}if(i===-1||c===-1)return o(new DOMException("Could not find fmt and data chunks in WAV file","DataCloneError"));const u=n.getUint16(i+2,!0),b=n.getUint32(i+4,!0),h=n.getUint16(i+14,!0);if(h!==16)return o(new DOMException(`Unsupported bitsPerSample: ${h}. Only 16-bit PCM is supported.`,"NotSupportedError"));const E=Array.from({length:u},()=>new Float32Array(g/(u*(h/8)))),L=g/(h/8);for(let p=0;p<L;p++){const _=c+p*(h/8),U=p%u,I=Math.floor(p/u),R=n.getInt16(_,!0);E[U][I]=R/32768}t(new a({sampleRate:b,numberOfChannels:u,pcmData:E}))}catch(n){o(n)}})}}}typeof self.OfflineAudioContext>"u"&&(self.OfflineAudioContext=self.AudioContext),self.exports={},importScripts("/genai_bundle.js");const{FilesetResolver:m,LlmInference:f}=self.exports,y="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-genai@0.10.25/wasm";let l=null,w=null;const O=async s=>{const{modelBlob:a,modelSource:r,options:e}=s;l&&(await l.close(),l=null);try{if(!("gpu"in navigator))throw new Error("WebGPU is not supported.");if(!a)throw new Error(`Model data for ${r} not found.`);const t=URL.createObjectURL(a),o=await m.forGenAiTasks(y),{maxTokens:n=4096,topK:i=40,temperature:c=.3,randomSeed:g=101,supportAudio:d=!1,maxNumImages:u=1}=e;l=await f.createFromOptions(o,{baseOptions:{modelAssetPath:t,delegate:"GPU"},maxTokens:n,topK:i,temperature:c,randomSeed:g,supportAudio:d,maxNumImages:u}),URL.revokeObjectURL(t),self.postMessage({type:"init_done",payload:{modelIdentifier:r}})}catch(t){l=null;const o=t instanceof Error?t.message:"Unknown initialization error.";self.postMessage({type:"init_error",payload:{error:o}})}},k=async()=>{l&&(console.log("Unloading offline model from inference worker..."),await l.close(),l=null,console.log("Offline model unloaded successfully.")),self.postMessage({type:"unload_done"})},M=(s,a,r,e)=>{if(!l)throw new Error("Offline model is not initialized.");w=new AbortController;const t=w.signal;return new Promise((o,n)=>{const i=()=>n(new DOMException("Translation cancelled.","AbortError"));t.addEventListener("abort",i,{once:!0});try{let c="";const g=(b,h)=>{t.aborted||(c+=b,e&&self.postMessage({type:"translation_chunk",payload:{chunk:b}}),h&&(t.removeEventListener("abort",i),o(c.trim())))},u=`Translate the following ${a==="Auto Detect"?"auto-detect the source language":`from ${a}`} text into concise ${r}: "${s}". 
 Provide *only* the translated text. Do not include any additional explanations, commentary, or greetings.`;l.generateResponse(u,g)}catch(c){t.removeEventListener("abort",i),n(c)}})},C=async s=>{if(!l)return self.postMessage({type:"extract_text_error",payload:{error:"Offline model not initialized."}});const{imageBitmap:a}=s,r="Extract all text from the following image. Return only the extracted text without any extra comments or explanations.";try{const e=await l.generateResponse([`<start_of_turn>user
${r}
`,{imageSource:a},`<end_of_turn>
<start_of_turn>model
`]);a.close(),self.postMessage({type:"extract_text_done",payload:{text:e.trim()}})}catch(e){console.error("OCR Worker Error:",e);const t=e instanceof Error?e.message:"Offline image text extraction failed.";self.postMessage({type:"extract_text_error",payload:{error:t}})}},A=async s=>{if(!l)return self.postMessage({type:"transcribe_error",payload:{error:"Offline model not initialized."}});const{audioData:a,sourceLang:r}=s;let e=null;try{e=URL.createObjectURL(a);const o=`Transcribe the following audio. ${r==="Auto Detect"?"Auto-detect the language.":`The language is ${r}.`}  Return only the transcribed text.`,n=await l.generateResponse([`<start_of_turn>user
 ${o} <end_of_turn>
<start_of_turn>model
`,{audioSource:e}]);(!n||n.trim()==="")&&console.warn("Model returned an empty response for transcription."),self.postMessage({type:"transcribe_done",payload:{text:n.trim()}})}catch(t){console.error("Transcription Internal Error:",t);const o=t instanceof Error?t.message:"Offline audio transcription failed.";self.postMessage({type:"transcribe_error",payload:{error:o}})}finally{e&&URL.revokeObjectURL(e)}};self.onmessage=async s=>{const{type:a,payload:r}=s.data;try{switch(a){case"init":await O(r);break;case"unload":await k();break;case"translate_stream":{const e=await M(r.text,r.sourceLang,r.targetLang,!0);self.postMessage({type:"translation_done",payload:{result:e}});break}case"translate_full":{const e=await M(r.text,r.sourceLang,r.targetLang,!1);self.postMessage({type:"translation_full_done",payload:{result:e}});break}case"cancel_task":w==null||w.abort();break;case"extractText":await C(r);break;case"transcribe":await A(r);break;default:console.warn(`Unknown inference worker message type: ${a}`)}}catch(e){const t=e instanceof DOMException&&e.name==="AbortError",o=a.replace("_stream","").replace("_full","");if(t)self.postMessage({type:"translation_cancelled"});else{const n=e instanceof Error?e.message:`Unknown error in ${a}.`;self.postMessage({type:`${o}_error`,payload:{error:n}})}}finally{w=null}}})();
