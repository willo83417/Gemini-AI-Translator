var Ro=Object.defineProperty;var Co=(D,G,ce)=>G in D?Ro(D,G,{enumerable:!0,configurable:!0,writable:!0,value:ce}):D[G]=ce;var Pe=(D,G,ce)=>Co(D,typeof G!="symbol"?G+"":G,ce);(function(){"use strict";var D=typeof self<"u"?self:{};function G(e,t){e:{for(var r=["CLOSURE_FLAGS"],n=D,o=0;o<r.length;o++)if((n=n[r[o]])==null){r=null;break e}r=n}return(e=r&&r[e])!=null?e:t}let ce;const Ln=typeof TextEncoder<"u";function qt(e){if(Ln)e=(ce||(ce=new TextEncoder)).encode(e);else{let r=0;const n=new Uint8Array(3*e.length);for(let o=0;o<e.length;o++){var t=e.charCodeAt(o);if(t<128)n[r++]=t;else{if(t<2048)n[r++]=t>>6|192;else{if(t>=55296&&t<=57343){if(t<=56319&&o<e.length){const i=e.charCodeAt(++o);if(i>=56320&&i<=57343){t=1024*(t-55296)+i-56320+65536,n[r++]=t>>18|240,n[r++]=t>>12&63|128,n[r++]=t>>6&63|128,n[r++]=63&t|128;continue}o--}t=65533}n[r++]=t>>12|224,n[r++]=t>>6&63|128}n[r++]=63&t|128}}e=r===n.length?n:n.subarray(0,r)}return e}var wt,On=G(610401301,!1),Kt=G(748402147,G(1,!0));function Yt(){var e=D.navigator;return e&&(e=e.userAgent)?e:""}const Jt=D.navigator;wt=Jt&&Jt.userAgentData||null;var Xt={},Le=null;function xn(e){const t=e.length;let r=3*t/4;r%3?r=Math.floor(r):"=.".indexOf(e[t-1])!=-1&&(r="=.".indexOf(e[t-2])!=-1?r-2:r-1);const n=new Uint8Array(r);let o=0;return function(i,s){function a(u){for(;l<i.length;){const c=i.charAt(l++),h=Le[c];if(h!=null)return h;if(!/^[\s\xa0]*$/.test(c))throw Error("Unknown base64 encoding at char: "+c)}return u}Qt();let l=0;for(;;){const u=a(-1),c=a(0),h=a(64),d=a(64);if(d===64&&u===-1)break;s(u<<2|c>>4),h!=64&&(s(c<<4&240|h>>2),d!=64&&s(h<<6&192|d))}}(e,function(i){n[o++]=i}),o!==r?n.subarray(0,o):n}function Qt(){if(!Le){Le={};var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),t=["+/=","+/","-_=","-_.","-_"];for(let r=0;r<5;r++){const n=e.concat(t[r].split(""));Xt[r]=n;for(let o=0;o<n.length;o++){const i=n[o];Le[i]===void 0&&(Le[i]=o)}}}}var kn=typeof Uint8Array<"u",Zt=!(!(On&&wt&&wt.brands.length>0)&&(Yt().indexOf("Trident")!=-1||Yt().indexOf("MSIE")!=-1))&&typeof btoa=="function";const er=/[-_.]/g,Un={"-":"+",_:"/",".":"="};function jn(e){return Un[e]||""}function tr(e){if(!Zt)return xn(e);e=er.test(e)?e.replace(er,jn):e,e=atob(e);const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}function bt(e){return kn&&e!=null&&e instanceof Uint8Array}var Oe={};function vt(){return Mn||(Mn=new J(null,Oe))}var J=class{constructor(e,t){if(rr(t),this.i=e,e!=null&&e.length===0)throw Error("ByteString should be constructed with non-empty values")}};let Mn,Bn;function rr(e){if(e!==Oe)throw Error("illegal external caller")}function nr(e,t){e.__closure__error__context__984382||(e.__closure__error__context__984382={}),e.__closure__error__context__984382.severity=t}function xe(e){return nr(e=Error(e),"warning"),e}function We(e,t){if(e!=null){var r=Bn??(Bn={}),n=r[e]||0;n>=t||(r[e]=n+1,nr(e=Error(),"incident"),function(o){D.setTimeout(()=>{throw o},0)}(e))}}var qe=typeof Symbol=="function"&&typeof Symbol()=="symbol";function ke(e,t,r=!1){return typeof Symbol=="function"&&typeof Symbol()=="symbol"?r&&Symbol.for&&e?Symbol.for(e):e!=null?Symbol(e):Symbol():t}var Nn=ke("jas",void 0,!0),Ue=ke(void 0,"1oa"),St=ke(void 0,"0ubsb"),Dn=ke(void 0,"0actk"),Ke=ke("m_m","oa",!0);const or={ga:{value:0,configurable:!0,writable:!0,enumerable:!1}},ir=Object.defineProperties,g=qe?Nn:"ga";var he;const sr=[];function ar(e,t){qe||g in e||ir(e,or),e[g]|=t}function U(e,t){qe||g in e||ir(e,or),e[g]=t}function Et(){return typeof BigInt=="function"}U(sr,7),he=Object.freeze(sr);var Ye={};function z(e,t){return t===void 0?e.i!==fe&&!!(2&(0|e.m[g])):!!(2&t)&&e.i!==fe}const fe={};var Rn=Object.freeze({});function Je(e){return e.na=!0,e}var Cn=Je(e=>typeof e=="number"),lr=Je(e=>typeof e=="string"),Fn=Je(e=>typeof e=="boolean"),Xe=typeof D.BigInt=="function"&&typeof D.BigInt(0)=="bigint",Vn=Je(e=>Xe?e>=zn&&e<=Hn:e[0]==="-"?ur(e,Gn):ur(e,$n));const Gn=Number.MIN_SAFE_INTEGER.toString(),zn=Xe?BigInt(Number.MIN_SAFE_INTEGER):void 0,$n=Number.MAX_SAFE_INTEGER.toString(),Hn=Xe?BigInt(Number.MAX_SAFE_INTEGER):void 0;function ur(e,t){if(e.length>t.length)return!1;if(e.length<t.length||e===t)return!0;for(let r=0;r<e.length;r++){const n=e[r],o=t[r];if(n>o)return!1;if(n<o)return!0}}let Wn,b=0,v=0;function cr(e){const t=e>>>0;b=t,v=(e-t)/4294967296>>>0}function de(e){if(e<0){cr(-e);const[t,r]=At(b,v);b=t>>>0,v=r>>>0}else cr(e)}function hr(e,t){const r=4294967296*t+(e>>>0);return Number.isSafeInteger(r)?r:je(e,t)}function je(e,t){if(e>>>=0,(t>>>=0)<=2097151)var r=""+(4294967296*t+e);else Et()?r=""+(BigInt(t)<<BigInt(32)|BigInt(e)):(e=(16777215&e)+6777216*(r=16777215&(e>>>24|t<<8))+6710656*(t=t>>16&65535),r+=8147497*t,t*=2,e>=1e7&&(r+=e/1e7>>>0,e%=1e7),r>=1e7&&(t+=r/1e7>>>0,r%=1e7),r=t+fr(r)+fr(e));return r}function fr(e){return e=String(e),"0000000".slice(e.length)+e}function Qe(e){if(e.length<16)de(Number(e));else if(Et())e=BigInt(e),b=Number(e&BigInt(4294967295))>>>0,v=Number(e>>BigInt(32)&BigInt(4294967295));else{const t=+(e[0]==="-");v=b=0;const r=e.length;for(let n=t,o=(r-t)%6+t;o<=r;n=o,o+=6){const i=Number(e.slice(n,o));v*=1e6,b=1e6*b+i,b>=4294967296&&(v+=Math.trunc(b/4294967296),v>>>=0,b>>>=0)}if(t){const[n,o]=At(b,v);b=n,v=o}}}function At(e,t){return t=~t,e?e=1+~e:t+=1,[e,t]}function Me(e){return Array.prototype.slice.call(e)}const qn=typeof BigInt=="function"?BigInt.asIntN:void 0,Kn=typeof BigInt=="function"?BigInt.asUintN:void 0,Be=Number.isSafeInteger,pe=Number.isFinite,Ze=Math.trunc;function Tt(e){if(e!=null&&typeof e!="number")throw Error(`Value of float/double field must be a number, found ${typeof e}: ${e}`);return e}function dr(e){return e==null||typeof e=="number"?e:e==="NaN"||e==="Infinity"||e==="-Infinity"?Number(e):void 0}function ie(e){if(e!=null&&typeof e!="boolean"){var t=typeof e;throw Error(`Expected boolean but got ${t!="object"?t:e?Array.isArray(e)?"array":t:"null"}: ${e}`)}return e}function ee(e){return e==null||typeof e=="boolean"?e:typeof e=="number"?!!e:void 0}const Yn=/^-?([1-9][0-9]*|0)(\.[0-9]+)?$/;function pr(e){switch(typeof e){case"bigint":return!0;case"number":return pe(e);case"string":return Yn.test(e);default:return!1}}function mr(e){if(typeof e!="number"||!pe(e))throw xe("int32");return 0|e}function It(e){return e==null?e:mr(e)}function me(e){if(e==null)return e;if(typeof e=="string"&&e)e=+e;else if(typeof e!="number")return;return pe(e)?0|e:void 0}function et(e){if(e==null)return e;if(typeof e=="string"&&e)e=+e;else if(typeof e!="number")return;return pe(e)?e>>>0:void 0}function gr(e){if(e[0]==="-")return!1;const t=e.length;return t<20||t===20&&Number(e.substring(0,6))<184467}function Jn(e){if(e==null)return e;var t=typeof e;if(t==="bigint")return String(Kn(64,e));if(pr(e)){if(t==="string")return t=Ze(Number(e)),Be(t)&&t>=0?e=String(t):((t=e.indexOf("."))!==-1&&(e=e.substring(0,t)),gr(e)||(Qe(e),e=je(b,v))),e;if(t==="number")return(e=Ze(e))>=0&&Be(e)?e:function(r){if(r<0){de(r);var n=je(b,v);return r=Number(n),Be(r)?r:n}return gr(n=String(r))?n:(de(r),hr(b,v))}(e)}}function Pt(e){return e==null||typeof e=="string"?e:void 0}function yr(e,t,r){if(e!=null&&e[Ke]===Ye)return e;if(Array.isArray(e)){var n=0|e[g];return(r=n|32&r|2&r)!==n&&U(e,r),new t(e)}}function tt(e,t,r,n){var o=n!==void 0;n=!!n;const i=[];var s=e.length;let a,l=4294967295,u=!1;const c=!!(64&t),h=c?128&t?0:-1:void 0;for(1&t||(a=s&&e[s-1],a!=null&&typeof a=="object"&&a.constructor===Object?l=--s:a=void 0,!c||128&t||o||(u=!0,l=l-h+h)),t=void 0,o=0;o<s;o++){let d=e[o];if(d!=null&&(d=r(d,n))!=null)if(c&&o>=l){const m=o-h;(t??(t={}))[m]=d}else i[o]=d}if(a)for(let d in a){if((e=a[d])==null||(e=r(e,n))==null)continue;let m;s=+d,c&&!Number.isNaN(s)&&(m=s+h)<l?i[m]=e:(t??(t={}))[d]=e}return t&&(u?i.push(t):i[l]=t),i}function Lt(e){switch(typeof e){case"number":return Number.isFinite(e)?e:""+e;case"bigint":return Vn(e)?Number(e):""+e;case"boolean":return e?1:0;case"object":if(Array.isArray(e)){var t=0|e[g];return e.length===0&&1&t?void 0:tt(e,t,Lt)}if(e!=null&&e[Ke]===Ye)return _r(e);if(e instanceof J){if((t=e.i)==null)e="";else if(typeof t=="string")e=t;else{if(Zt){for(var r="",n=0,o=t.length-10240;n<o;)r+=String.fromCharCode.apply(null,t.subarray(n,n+=10240));r+=String.fromCharCode.apply(null,n?t.subarray(n):t),t=btoa(r)}else{r===void 0&&(r=0),Qt(),r=Xt[r],n=Array(Math.floor(t.length/3)),o=r[64]||"";let u=0,c=0;for(;u<t.length-2;u+=3){var i=t[u],s=t[u+1],a=t[u+2],l=r[i>>2];i=r[(3&i)<<4|s>>4],s=r[(15&s)<<2|a>>6],a=r[63&a],n[c++]=l+i+s+a}switch(l=0,a=o,t.length-u){case 2:a=r[(15&(l=t[u+1]))<<2]||o;case 1:t=t[u],n[c]=r[t>>2]+r[(3&t)<<4|l>>4]+a+o}t=n.join("")}e=e.i=t}return e}return}return e}function _r(e){return tt(e=e.m,0|e[g],Lt)}let Xn,Qn;function Zn(e,t,r){return wr(e,t[0],t[1],2)}function wr(e,t,r,n=0){if(e==null){var o=32;r?(e=[r],o|=128):e=[],t&&(o=-8380417&o|(1023&t)<<13)}else{if(!Array.isArray(e))throw Error("narr");if(o=0|e[g],Kt&&1&o)throw Error("rfarr");if(2048&o&&!(2&o)&&function(){if(Kt)throw Error("carr");We(Dn,5)}(),256&o)throw Error("farr");if(64&o)return n!==0||2048&o||U(e,2048|o),e;if(r&&(o|=128,r!==e[0]))throw Error("mid");e:{o|=64;var i=(r=e).length;if(i){var s=i-1;const l=r[s];if(l!=null&&typeof l=="object"&&l.constructor===Object){if((s-=t=128&o?0:-1)>=1024)throw Error("pvtlmt");for(var a in l)(i=+a)<s&&(r[i+t]=l[a],delete l[a]);o=-8380417&o|(1023&s)<<13;break e}}if(t){if((a=Math.max(t,i-(128&o?0:-1)))>1024)throw Error("spvt");o=-8380417&o|(1023&a)<<13}}}return o|=64,n===0&&(o|=2048),U(e,o),e}function eo(e,t){if(typeof e!="object")return e;if(Array.isArray(e)){var r=0|e[g];return e.length===0&&1&r?e=void 0:2&r||(!t||4096&r||16&r?e=rt(e,r,!1,t&&!(16&r)):(ar(e,34),4&r&&Object.freeze(e))),e}return e!=null&&e[Ke]===Ye?z(e,r=0|(t=e.m)[g])?e:vr(e,t,r)?br(e,t):rt(t,r):e instanceof J?e:void 0}function br(e,t,r){return e=new e.constructor(t),r&&(e.i=fe),e.o=fe,e}function rt(e,t,r,n){return n??(n=!!(34&t)),e=tt(e,t,eo,n),n=32,r&&(n|=2),U(e,t=8380609&t|n),e}function nt(e){if(e.i!==fe)return!1;var t=e.m;return ar(t=rt(t,0|t[g]),2048),e.m=t,e.i=void 0,e.o=void 0,!0}function ge(e){if(!nt(e)&&z(e,0|e.m[g]))throw Error()}function ye(e,t){t===void 0&&(t=0|e[g]),32&t&&!(4096&t)&&U(e,4096|t)}function vr(e,t,r){return!!(2&r)||!(!(32&r)||4096&r)&&(U(t,2|r),e.i=fe,!0)}function R(e,t,r){if((e=ot(e.m,t,void 0,r))!==null)return e}function ot(e,t,r,n){if(t===-1)return null;const o=t+(r?0:-1),i=e.length-1;let s,a;if(!(i<1+(r?0:-1))){if(o>=i)if(s=e[i],s!=null&&typeof s=="object"&&s.constructor===Object)r=s[t],a=!0;else{if(o!==i)return;r=s}else r=e[o];if(n&&r!=null){if((n=n(r))==null)return n;if(!Object.is(n,r))return a?s[t]=n:e[o]=n,n}return r}}function se(e,t,r){ge(e),W(e=e.m,0|e[g],t,r)}function W(e,t,r,n,o){const i=r+-1;var s=e.length-1;if(s>=0&&i>=s){const a=e[s];if(a!=null&&typeof a=="object"&&a.constructor===Object)return a[r]=n,t}return i<=s?(e[i]=n,t):(n!==void 0&&(r>=(s=(t??(t=0|e[g]))>>13&1023||536870912)?n!=null&&(e[s+-1]={[r]:n}):e[i]=n),t)}function Sr(e,t,r,n,o){let i=e.m,s=0|i[g];n=z(e,s)?1:n,o=!!o||n===3,n===2&&nt(e)&&(i=e.m,s=0|i[g]);let a=(e=Ar(i,t))===he?7:0|e[g],l=Tr(a,s);var u=!(4&l);if(u){4&l&&(e=Me(e),a=0,l=De(l,s),s=W(i,s,t,e));let c=0,h=0;for(;c<e.length;c++){const d=r(e[c]);d!=null&&(e[h++]=d)}h<c&&(e.length=h),r=-513&(4|l),l=r&=-1025,l&=-4097}return l!==a&&(U(e,l),2&l&&Object.freeze(e)),Er(e,l,i,s,t,n,u,o)}function Er(e,t,r,n,o,i,s,a){let l=t;return i===1||i===4&&(2&t||!(16&t)&&32&n)?it(t)||((t|=!e.length||s&&!(4096&t)||32&n&&!(4096&t||16&t)?2:256)!==l&&U(e,t),Object.freeze(e)):(i===2&&it(t)&&(e=Me(e),l=0,t=De(t,n),n=W(r,n,o,e)),it(t)||(a||(t|=16),t!==l&&U(e,t))),2&t||!(4096&t||16&t)||ye(r,n),e}function Ar(e,t,r){return e=ot(e,t,r),Array.isArray(e)?e:he}function Tr(e,t){return 2&t&&(e|=2),1|e}function it(e){return!!(2&e)&&!!(4&e)||!!(256&e)}function Ir(e,t,r){ge(e);let n=0|(e=e.m)[g];if(r==null)W(e,n,t);else{var o=r===he?7:0|r[g],i=o,s=it(o),a=s||Object.isFrozen(r);for(s||(o=0),a||(r=Me(r),i=0,o=De(o,n),a=!1),o|=5,s=0;s<r.length;s++){const l=r[s],u=mr(l);Object.is(l,u)||(a&&(r=Me(r),i=0,o=De(o,n),a=!1),r[s]=u)}o!==i&&(a&&(r=Me(r),o=De(o,n)),U(r,o)),W(e,n,t,r)}}function C(e,t,r,n){ge(e),W(e=e.m,0|e[g],t,(n==="0"?Number(r)===0:r===n)?void 0:r)}function Pr(e){if(qe)return e[Ue]??(e[Ue]=new Map);if(Ue in e)return e[Ue];const t=new Map;return Object.defineProperty(e,Ue,{value:t}),t}function Lr(e,t,r){var n=yt;let o=e.get(n);if(o!=null)return o;o=0;for(let i=0;i<n.length;i++){const s=n[i];ot(t,s)!=null&&(o!==0&&(r=W(t,r,o)),o=s)}return e.set(n,o),o}function Ne(e,t,r){let n=e.m,o=0|n[g];if(t=function(a,l,u,c){let h=!1;if((c=ot(a,c,void 0,d=>{const m=yr(d,u,l);return h=m!==d&&m!=null,m}))!=null)return h&&!z(c)&&ye(a,l),c}(n,o,t,r),t==null)return t;if(o=0|n[g],!z(e,o)){var i,s=t;const a=s.m,l=0|a[g];(i=z(s,l)?vr(s,a,l)?br(s,a,!0):new s.constructor(rt(a,l,!1)):s)!==t&&(nt(e)&&(n=e.m,o=0|n[g]),o=W(n,o,r,t=i),ye(n,o))}return t}function Or(e){return e==null&&(e=void 0),e}function te(e,t,r){return se(e,t,r=Or(r)),r&&!z(r)&&ye(e.m),e}function De(e,t){return-273&(2&t?2|e:-3&e)}function Re(e,t,r,n){var o=n;ge(e);var i=n=e.m,s=0|n[g];const a=z(e,s)?1:2;a===2&&nt(e)&&(s=0|(i=e.m)[g]);let l=(e=Ar(i,t))===he?7:0|e[g];var u=Tr(l,s);const c=!(4&u);if(c){var h=e,d=s;const m=!!(2&u);m&&(d|=2);let w=!m,x=!0,_=0,E=0;for(;_<h.length;_++){const I=yr(h[_],r,d);if(I instanceof r){if(!m){const V=z(I);w&&(w=!V),x&&(x=V)}h[E++]=I}}E<_&&(h.length=E),u|=4,u=x?-4097&u:4096|u,u=w?8|u:-9&u}u!==l&&(U(e,u),2&u&&Object.freeze(e)),t=e=Er(e,u,i,s,t,a,c,!0),o=o??new r,t.push(o),i=r=t===he?7:0|t[g],(o=z(o))?(r&=-9,t.length===1&&(r&=-4097)):r|=4096,r!==i&&U(t,r),o||ye(n)}function k(e,t){return et(R(e,t))??0}function q(e,t,r){C(e,t,It(r),0)}function Ce(e,t,r){if(r!=null){if(typeof r!="number"||!pe(r))throw xe("uint32");r>>>=0}se(e,t,r)}function j(e,t,r){if(r!=null&&typeof r!="string")throw Error();C(e,t,r,"")}function p(e,t,r){if(ge(e),t=(e=Sr(e,t,Pt,2,!0)).push,typeof r!="string")throw Error();t.call(e,r)}var _e=class{constructor(e,t,r){if(this.buffer=e,r&&!t)throw Error()}};function xr(e){if(typeof e=="string")return new _e(tr(e),!0);if(Array.isArray(e))return new _e(new Uint8Array(e),!0);if(e.constructor===Uint8Array)return new _e(e,!1);if(e.constructor===ArrayBuffer)return e=new Uint8Array(e),new _e(e,!1);if(e.constructor===J){rr(Oe);var t=e.i;return t=((t=t==null||bt(t)?t:typeof t=="string"?tr(t):null)==null?t:e.i=t)||new Uint8Array(0),new _e(t,!0,e)}if(e instanceof Uint8Array)return e=e.constructor===Uint8Array?e:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),new _e(e,!1);throw Error()}function kr(e){return e?/^\d+$/.test(e)?(Qe(e),new Ot(b,v)):null:to||(to=new Ot(0,0))}var Ot=class{constructor(e,t){this.j=e>>>0,this.i=t>>>0}};let to;function Ur(e){return e?/^-?\d+$/.test(e)?(Qe(e),new xt(b,v)):null:ro||(ro=new xt(0,0))}var xt=class{constructor(e,t){this.j=e>>>0,this.i=t>>>0}};let ro;function we(e,t,r){for(;r>0||t>127;)e.i.push(127&t|128),t=(t>>>7|r<<25)>>>0,r>>>=7;e.i.push(t)}function st(e,t){for(;t>127;)e.i.push(127&t|128),t>>>=7;e.i.push(t)}function at(e,t){if(t>=0)st(e,t);else{for(let r=0;r<9;r++)e.i.push(127&t|128),t>>=7;e.i.push(1)}}function lt(e,t){t.length!==0&&(e.l.push(t),e.j+=t.length)}function X(e,t,r){st(e.i,8*t+r)}function ut(e,t){return X(e,t,2),t=e.i.end(),lt(e,t),t.push(e.j),t}function ct(e,t){var r=t.pop();for(r=e.j+e.i.length()-r;r>127;)t.push(127&r|128),r>>>=7,e.j++;t.push(r),e.j++}function ht(e,t,r){X(e,t,2),st(e.i,r.length),lt(e,e.i.end()),lt(e,r)}function K(){const e=class{constructor(){throw Error()}};return Object.setPrototypeOf(e,e.prototype),e}var Fe=K(),jr=K(),ft=K(),dt=K(),no=K(),oo=K(),io=K(),Mr=K(),so=K(),kt=K(),A=class{constructor(e,t){this.m=wr(e,t)}toJSON(){return _r(this)}};A.prototype[Ke]=Ye,A.prototype.toString=function(){return this.m.toString()};var Y=class{constructor(e,t){this.i=e,e=Fe,this.j=!!e&&t===e||!1}};function Br(e,t,r,n,o){(t=Cr(t,n))!=null&&(r=ut(e,r),o(t,e),ct(e,r))}const ao=new Y(Br,Fe),lo=new Y(Br,Fe);var Nr=Symbol(),Dr=Symbol();let Rr;function pt(e){var t=uo,r=co,n=e[Nr];if(n)return n;(n={}).ma=e,n.W=function(c){switch(typeof c){case"boolean":return Xn||(Xn=[0,void 0,!0]);case"number":return c>0?void 0:c===0?Qn||(Qn=[0,void 0]):[-c,void 0];case"string":return[0,c];case"object":return c}}(e[0]);var o=e[1];let i=1;o&&o.constructor===Object&&(n.ba=o,typeof(o=e[++i])=="function"&&(n.ha=!0,Rr??(Rr=e[i+1]),o=e[i+=2]));const s={};for(;o&&Array.isArray(o)&&o.length&&typeof o[0]=="number"&&o[0]>0;){for(var a=0;a<o.length;a++)s[o[a]]=o;o=e[++i]}for(a=1;o!==void 0;){let c;typeof o=="number"&&(a+=o,o=e[++i]);var l=void 0;if(o instanceof Y?c=o:(c=ao,i--),c==null?void 0:c.j){o=e[++i],l=e;var u=i;typeof o=="function"&&(o=o(),l[u]=o),l=o}for(u=a+1,typeof(o=e[++i])=="number"&&o<0&&(u-=o,o=e[++i]);a<u;a++)l?r(n,a,c,l):t(n,a,c)}return e[Nr]=n}function Cr(e,t){return e instanceof A?e.m:Array.isArray(e)?Zn(e,t):void 0}function uo(e,t,r){e[t]=r.i}function co(e,t,r,n){let o,i;const s=r.i;e[t]=(a,l,u)=>s(a,l,u,i||(i=pt(n).W),o||(o=Fr(n)))}function Fr(e){let t=e[Dr];if(!t){const r=pt(e);t=(n,o)=>Vr(n,o,r),e[Dr]=t}return t}function Vr(e,t,r){(function(n,o,i){const s=128&o?0:-1,a=n.length;var l;(l=!!a)&&(l=(l=n[a-1])!=null&&typeof l=="object"&&l.constructor===Object);const u=a+(l?-1:0);for(o=128&o?1:0;o<u;o++)i(o-s,n[o]);if(l){n=n[a-1];for(const c in n)!isNaN(c)&&i(+c,n[c])}})(e,0|e[g],(n,o)=>{if(o!=null){var i=function(s,a){var l=s[a];if(l)return l;if((l=s.ba)&&(l=l[a])){var u=(l=Array.isArray(l)?l[0]instanceof Y?l:[lo,l]:[l,void 0])[0].i;if(l=l[1]){const c=Fr(l),h=pt(l).W;l=s.ha?Rr(h,c):(d,m,w)=>u(d,m,w,h,c)}else l=u;return s[a]=l}}(r,n);i?i(t,o,n):n<500||We(St,3)}})}var Ut,ae=0,be=ae;if(lr(be)){if(!/^\s*(?:-?[1-9]\d*|0)?\s*$/.test(be))throw Error(String(be))}else if((Ut=Cn(be))&&(Ut=!Number.isSafeInteger(be)),Ut)throw Error(String(be));function jt(e,t){if(Array.isArray(t)){var r=0|t[g];if(4&r)return t;for(var n=0,o=0;n<t.length;n++){const i=e(t[n]);i!=null&&(t[o++]=i)}return o<n&&(t.length=o),U(t,-1537&(5|r)),2&r&&Object.freeze(t),t}}function L(e,t){return new Y(e,t)}function Gr(e,t,r){(t=dr(t))!=null&&(X(e,r,5),e=e.i,(r=Wn||(Wn=new DataView(new ArrayBuffer(8)))).setFloat32(0,+t,!0),v=0,t=b=r.getUint32(0,!0),e.i.push(t>>>0&255),e.i.push(t>>>8&255),e.i.push(t>>>16&255),e.i.push(t>>>24&255))}function Mt(e,t,r){(t=me(t))!=null&&t!=null&&(X(e,r,0),at(e.i,t))}function zr(e,t,r){(t=ee(t))!=null&&(X(e,r,0),e.i.i.push(t?1:0))}function Bt(e,t,r){(t=Pt(t))!=null&&ht(e,r,qt(t))}function $r(e,t,r,n,o){(t=Cr(t,n))!=null&&(r=ut(e,r),o(t,e),ct(e,r))}function Hr(e,t,r){(t=me(t))!=null&&(t=parseInt(t,10),X(e,r,0),at(e.i,t))}Xe||(ae=Fn(ae)?ae?"1":"0":lr(ae)?ae.trim()||"0":String(ae));var ve,mt=L(Gr,Mr),Nt=L(Gr,Mr),Dt=L(function(e,t,r){if(t=function(n){if(n==null)return n;var o=typeof n;if(o==="bigint")return String(qn(64,n));if(pr(n)){if(o==="string"){if(o=Ze(Number(n)),Be(o))n=String(o);else if((o=n.indexOf("."))!==-1&&(n=n.substring(0,o)),o=n.length,!(n[0]==="-"?o<20||o===20&&Number(n.substring(0,7))>-922337:o<19||o===19&&Number(n.substring(0,6))<922337))if(Qe(n),n=b,2147483648&(o=v))if(Et())n=""+(BigInt(0|o)<<BigInt(32)|BigInt(n>>>0));else{const[s,a]=At(n,o);n="-"+je(s,a)}else n=je(n,o);return n}if(o==="number"){if(n=Ze(n),!Be(n)){de(n),o=b;var i=v;(n=2147483648&i)&&(i=~i>>>0,(o=1+~o>>>0)==0&&(i=i+1>>>0)),n=typeof(o=hr(o,i))=="number"?n?-o:o:n?"-"+o:o}return n}}}(t),t!=null&&(typeof t=="string"&&Ur(t),t!=null))switch(X(e,r,0),typeof t){case"number":e=e.i,de(t),we(e,b,v);break;case"bigint":r=BigInt.asUintN(64,t),r=new xt(Number(r&BigInt(4294967295)),Number(r>>BigInt(32))),we(e.i,r.j,r.i);break;default:r=Ur(t),we(e.i,r.j,r.i)}},oo),ho=L(function(e,t,r){if((t=Jn(t))!=null&&(typeof t=="string"&&kr(t),t!=null))switch(X(e,r,0),typeof t){case"number":e=e.i,de(t),we(e,b,v);break;case"bigint":r=BigInt.asUintN(64,t),r=new Ot(Number(r&BigInt(4294967295)),Number(r>>BigInt(32))),we(e.i,r.j,r.i);break;default:r=kr(t),we(e.i,r.j,r.i)}},io),$=L(Mt,dt);ve=new Y(function(e,t,r){if((t=jt(me,t))!=null&&t.length){r=ut(e,r);for(let n=0;n<t.length;n++)at(e.i,t[n]);ct(e,r)}},dt);var M,y=L(Mt,dt),fo=L(Mt,dt),T=L(zr,jr),S=L(zr,jr),P=L(Bt,ft);M=new Y(function(e,t,r){if((t=jt(Pt,t))!=null)for(let s=0;s<t.length;s++){var n=e,o=r,i=t[s];i!=null&&ht(n,o,qt(i))}},ft);var Rt,N=L(Bt,ft),Wr=L(Bt,ft),H=function(e,t,r=Fe){return new Y(t,r)}(0,function(e,t,r,n,o){if(Array.isArray(t))for(let i=0;i<t.length;i++)$r(e,t[i],r,n,o)}),F=new Y($r,Fe),po=L(function(e,t,r){(t=et(t))!=null&&t!=null&&(X(e,r,0),st(e.i,t))},no),re=L(Hr,kt);Rt=new Y(function(e,t,r){if((t=jt(me,t))!=null&&t.length){r=ut(e,r);for(let n=0;n<t.length;n++)at(e.i,t[n]);ct(e,r)}},kt);var Q=L(Hr,kt);function Ve(e){return function(){const t=new class{constructor(){this.l=[],this.j=0,this.i=new class{constructor(){this.i=[]}length(){return this.i.length}end(){const s=this.i;return this.i=[],s}}}};Vr(this.m,t,pt(e)),lt(t,t.i.end());const r=new Uint8Array(t.j),n=t.l,o=n.length;let i=0;for(let s=0;s<o;s++){const a=n[s];r.set(a,i),i+=a.length}return t.l=[r],r}}function Ct(e,t){if(t!=null)if(Array.isArray(t))se(e,2,tt(t,0,Lt));else{if(!(typeof t=="string"||t instanceof J||bt(t)))throw Error("invalid value in Any.value field: "+t+" expected a ByteString, a base64 encoded string, a Uint8Array or a jspb array");if(t!=null){if(typeof t=="string")t=t?new J(t,Oe):vt();else if(t.constructor!==J){if(!bt(t))throw Error();t=t.length?new J(new Uint8Array(t),Oe):vt()}}C(e,2,t,vt())}}var Se=class extends A{constructor(e){super(e)}},qr=[0,N,L(function(e,t,r){if(t!=null){if(t instanceof A){const n=t.pa;return void(n?(t=n(t),t!=null&&ht(e,r,xr(t).buffer)):We(St,3))}if(Array.isArray(t))return void We(St,3)}(t=t==null||typeof t=="string"||t instanceof J?t:void 0)!=null&&ht(e,r,xr(t).buffer)},so)];let Ft,Kr=globalThis.trustedTypes;function Yr(e){var t;return Ft===void 0&&(Ft=function(){let r=null;if(!Kr)return r;try{const n=o=>o;r=Kr.createPolicy("goog#html",{createHTML:n,createScript:n,createScriptURL:n})}catch{}return r}()),e=(t=Ft)?t.createScriptURL(e):e,new class{constructor(r){this.i=r}toString(){return this.i+""}}(e)}function mo(e,...t){if(t.length===0)return Yr(e[0]);let r=e[0];for(let n=0;n<t.length;n++)r+=encodeURIComponent(t[n])+e[n+1];return Yr(r)}var Jr={};Jr[336783863]=[0,P,T,-1,$,[0,[1,2,3,4,5,6,7,8,9],F,[0],F,[0,T,P,T,re,-1,Rt,P,-1,[0,T,-1],re,T,-1],F,[0,P,-2],F,[0,$,T,1,T,-3],F,[0,$,re,T,-1,ve,re,-1,T],F,[0,P,-2],F,[0,P,re],F,[0,re,P,-1,T],F,[0,re,-1,T]],[0,P],T,[0,[1,3],[2,4],F,[0,ve],-1,F,[0,M],-1,H,[0,P,-1]],P];var Xr=class extends A{constructor(e){super(e)}},Qr=[0,Dt,-1,S,-3,Dt,ve,N,y,Dt,-1,S,y,S,-2,N],Z=class extends A{constructor(e){super(e,500)}N(e){return te(this,7,e)}},Ge=[-1,{}],Zr=[0,P,1,Ge],en=[0,P,M,Ge];function ne(e,t){Re(e,1,Z,t)}var tn=class extends A{constructor(e){super(e,500)}N(e){return te(this,1001,e)}};tn.prototype.j=Ve([-500,H,[-500,N,-1,M,-3,[-2,Jr,T],H,qr,y,-1,Zr,en,H,[0,N,S],N,Qr,y,M,987,M],4,H,[-500,P,-1,[-1,{}],998,P],H,[-500,P,M,-1,[-2,{},T],997,M,-1],y,H,[-500,P,M,Ge,998,M],M,y,Zr,en,H,[0,N,-1,Ge],M,-2,Qr,N,-1,S,[0,S,po],978,Ge,H,qr]);var rn=class extends A{constructor(e){super(e)}};let gt;const go=new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]);async function nn(){if(gt===void 0)try{await WebAssembly.instantiate(go),gt=!0}catch{gt=!1}return gt}async function ze(e,t=mo``){const r=await nn()?"wasm_internal":"wasm_nosimd_internal";return{wasmLoaderPath:`${t}/${e}_${r}.js`,wasmBinaryPath:`${t}/${e}_${r}.wasm`}}var le=class{};function on(e){function t(s,a){return new ReadableStream({start(){},async pull(l){o=o.then(async()=>{if(s.cache.length>0)l.enqueue(s.cache.shift());else{var{value:u,done:c}=await e.read();u&&(a.active&&a.cache.push(u),s.active&&l.enqueue(u)),c&&l.close()}}),await o},cancel(){s.active=!1,s.cache.length=0,a.active||e.cancel()}})}var r={cache:[],active:!0};const n={cache:[],active:!0};let o=Promise.resolve();const i=t(r,n);return r=t(n,r),[i.getReader(),r.getReader()]}async function sn(e,t){const r=new Uint8Array(t);let n=0;for(;n<t;){const{value:o,done:i}=await e.read();if(o){const s=o.subarray(0,t-n);r.set(s,n),n+=s.length}if(i)throw Error(`Expected ${t} bytes, but stream ended after reading ${n} bytes.`)}return await e.cancel(),r}le.forVisionTasks=function(e){return ze("vision",e)},le.forTextTasks=function(e){return ze("text",e)},le.forGenAiExperimentalTasks=function(e){return ze("genai_experimental",e)},le.forGenAiTasks=function(e){return ze("genai",e)},le.forAudioTasks=function(e){return ze("audio",e)},le.isSimdSupported=function(){return nn()};const yo=[[0,async e=>{const t=new TextEncoder().encode("TFL3").length;return e=await sn(e,t+4),new TextDecoder("utf-8").decode(e.subarray(4,t+4))==="TFL3"}],[1,async e=>(e=await sn(e,6))[4]===80&&e[5]===75]];function _o(){var e=navigator;return typeof OffscreenCanvas<"u"&&(!function(t=navigator){return(t=t.userAgent).includes("Safari")&&!t.includes("Chrome")}(e)||!!((e=e.userAgent.match(/Version\/([\d]+).*Safari/))&&e.length>=1&&Number(e[1])>=17))}async function an(e){if(typeof importScripts!="function"){const t=document.createElement("script");return t.src=e.toString(),t.crossOrigin="anonymous",new Promise((r,n)=>{t.addEventListener("load",()=>{r()},!1),t.addEventListener("error",o=>{n(o)},!1),document.body.appendChild(t)})}importScripts(e.toString())}function f(e,t,r){e.o||console.error("No wasm multistream support detected: ensure dependency inclusion of :gl_graph_runner_internal_multi_input target"),r(t=e.h.stringToNewUTF8(t)),e.h._free(t)}function ln(e,t,r){e.o||console.error("No wasm multistream support detected: ensure dependency inclusion of :gl_graph_runner_internal_multi_input target");const n=new Uint32Array(t.length);for(let o=0;o<t.length;o++)n[o]=e.h.stringToNewUTF8(t[o]);t=e.h._malloc(4*n.length),e.h.HEAPU32.set(n,t>>2),r(t);for(const o of n)e.h._free(o);e.h._free(t)}function oe(e,t,r){e.h.simpleListeners=e.h.simpleListeners||{},e.h.simpleListeners[t]=r}function ue(e,t,r){let n=[];e.h.simpleListeners=e.h.simpleListeners||{},e.h.simpleListeners[t]=(o,i,s)=>{i?(r(n,s),n=[]):n.push(o)}}const wo=(un=class{constructor(e,t){this.l=!0,this.h=e,this.i=null,this.j=0,this.o=typeof this.h._addIntToInputStream=="function",t!==void 0?this.h.canvas=t:_o()?this.h.canvas=new OffscreenCanvas(1,1):(console.warn("OffscreenCanvas not supported and GraphRunner constructor glCanvas parameter is undefined. Creating backup canvas."),this.h.canvas=document.createElement("canvas"))}async initializeGraph(e){const t=await(await fetch(e)).arrayBuffer();e=!(e.endsWith(".pbtxt")||e.endsWith(".textproto")),this.setGraph(new Uint8Array(t),e)}setGraphFromString(e){this.setGraph(new TextEncoder().encode(e),!1)}setGraph(e,t){const r=e.length,n=this.h._malloc(r);this.h.HEAPU8.set(e,n),t?this.h._changeBinaryGraph(r,n):this.h._changeTextGraph(r,n),this.h._free(n)}configureAudio(e,t,r,n,o){this.h._configureAudio||console.warn('Attempting to use configureAudio without support for input audio. Is build dep ":gl_graph_runner_audio" missing?'),f(this,n||"input_audio",i=>{f(this,o=o||"audio_header",s=>{this.h._configureAudio(i,s,e,t??0,r)})})}setAutoResizeCanvas(e){this.l=e}setAutoRenderToScreen(e){this.h._setAutoRenderToScreen(e)}setGpuBufferVerticalFlip(e){this.h.gpuOriginForWebTexturesIsBottomLeft=e}attachErrorListener(e){this.h.errorListener=e}attachEmptyPacketListener(e,t){this.h.emptyPacketListeners=this.h.emptyPacketListeners||{},this.h.emptyPacketListeners[e]=t}addAudioToStream(e,t,r){this.addAudioToStreamWithShape(e,0,0,t,r)}addAudioToStreamWithShape(e,t,r,n,o){const i=4*e.length;this.j!==i&&(this.i&&this.h._free(this.i),this.i=this.h._malloc(i),this.j=i),this.h.HEAPF32.set(e,this.i/4),f(this,n,s=>{this.h._addAudioToInputStream(this.i,t,r,s,o)})}addGpuBufferToStream(e,t,r){f(this,t,n=>{if(!this.h.canvas)throw Error("No OpenGL canvas configured.");n?this.h._bindTextureToStream(n):this.h._bindTextureToCanvas();const o=this.h.canvas.getContext("webgl2")||this.h.canvas.getContext("webgl");if(!o)throw Error("Failed to obtain WebGL context from the provided canvas. `getContext()` should only be invoked with `webgl` or `webgl2`.");this.h.gpuOriginForWebTexturesIsBottomLeft&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),this.h.gpuOriginForWebTexturesIsBottomLeft&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!1);const[i,s]=e.videoWidth!==void 0?[e.videoWidth,e.videoHeight]:e.naturalWidth!==void 0?[e.naturalWidth,e.naturalHeight]:e.displayWidth!==void 0?[e.displayWidth,e.displayHeight]:[e.width,e.height];!this.l||i===this.h.canvas.width&&s===this.h.canvas.height||(this.h.canvas.width=i,this.h.canvas.height=s);const[a,l]=[i,s];this.h._addBoundTextureToStream(n,a,l,r)})}addBoolToStream(e,t,r){f(this,t,n=>{this.h._addBoolToInputStream(e,n,r)})}addDoubleToStream(e,t,r){f(this,t,n=>{this.h._addDoubleToInputStream(e,n,r)})}addFloatToStream(e,t,r){f(this,t,n=>{this.h._addFloatToInputStream(e,n,r)})}addIntToStream(e,t,r){f(this,t,n=>{this.h._addIntToInputStream(e,n,r)})}addUintToStream(e,t,r){f(this,t,n=>{this.h._addUintToInputStream(e,n,r)})}addStringToStream(e,t,r){f(this,t,n=>{f(this,e,o=>{this.h._addStringToInputStream(o,n,r)})})}addStringRecordToStream(e,t,r){f(this,t,n=>{ln(this,Object.keys(e),o=>{ln(this,Object.values(e),i=>{this.h._addFlatHashMapToInputStream(o,i,Object.keys(e).length,n,r)})})})}addProtoToStream(e,t,r,n){f(this,r,o=>{f(this,t,i=>{const s=this.h._malloc(e.length);this.h.HEAPU8.set(e,s),this.h._addProtoToInputStream(s,e.length,i,o,n),this.h._free(s)})})}addEmptyPacketToStream(e,t){f(this,e,r=>{this.h._addEmptyPacketToInputStream(r,t)})}addBoolVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateBoolVector(e.length);if(!o)throw Error("Unable to allocate new bool vector on heap.");for(const i of e)this.h._addBoolVectorEntry(o,i);this.h._addBoolVectorToInputStream(o,n,r)})}addDoubleVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateDoubleVector(e.length);if(!o)throw Error("Unable to allocate new double vector on heap.");for(const i of e)this.h._addDoubleVectorEntry(o,i);this.h._addDoubleVectorToInputStream(o,n,r)})}addFloatVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateFloatVector(e.length);if(!o)throw Error("Unable to allocate new float vector on heap.");for(const i of e)this.h._addFloatVectorEntry(o,i);this.h._addFloatVectorToInputStream(o,n,r)})}addIntVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateIntVector(e.length);if(!o)throw Error("Unable to allocate new int vector on heap.");for(const i of e)this.h._addIntVectorEntry(o,i);this.h._addIntVectorToInputStream(o,n,r)})}addUintVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateUintVector(e.length);if(!o)throw Error("Unable to allocate new unsigned int vector on heap.");for(const i of e)this.h._addUintVectorEntry(o,i);this.h._addUintVectorToInputStream(o,n,r)})}addStringVectorToStream(e,t,r){f(this,t,n=>{const o=this.h._allocateStringVector(e.length);if(!o)throw Error("Unable to allocate new string vector on heap.");for(const i of e)f(this,i,s=>{this.h._addStringVectorEntry(o,s)});this.h._addStringVectorToInputStream(o,n,r)})}addBoolToInputSidePacket(e,t){f(this,t,r=>{this.h._addBoolToInputSidePacket(e,r)})}addDoubleToInputSidePacket(e,t){f(this,t,r=>{this.h._addDoubleToInputSidePacket(e,r)})}addFloatToInputSidePacket(e,t){f(this,t,r=>{this.h._addFloatToInputSidePacket(e,r)})}addIntToInputSidePacket(e,t){f(this,t,r=>{this.h._addIntToInputSidePacket(e,r)})}addUintToInputSidePacket(e,t){f(this,t,r=>{this.h._addUintToInputSidePacket(e,r)})}addStringToInputSidePacket(e,t){f(this,t,r=>{f(this,e,n=>{this.h._addStringToInputSidePacket(n,r)})})}addProtoToInputSidePacket(e,t,r){f(this,r,n=>{f(this,t,o=>{const i=this.h._malloc(e.length);this.h.HEAPU8.set(e,i),this.h._addProtoToInputSidePacket(i,e.length,o,n),this.h._free(i)})})}addBoolVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateBoolVector(e.length);if(!n)throw Error("Unable to allocate new bool vector on heap.");for(const o of e)this.h._addBoolVectorEntry(n,o);this.h._addBoolVectorToInputSidePacket(n,r)})}addDoubleVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateDoubleVector(e.length);if(!n)throw Error("Unable to allocate new double vector on heap.");for(const o of e)this.h._addDoubleVectorEntry(n,o);this.h._addDoubleVectorToInputSidePacket(n,r)})}addFloatVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateFloatVector(e.length);if(!n)throw Error("Unable to allocate new float vector on heap.");for(const o of e)this.h._addFloatVectorEntry(n,o);this.h._addFloatVectorToInputSidePacket(n,r)})}addIntVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateIntVector(e.length);if(!n)throw Error("Unable to allocate new int vector on heap.");for(const o of e)this.h._addIntVectorEntry(n,o);this.h._addIntVectorToInputSidePacket(n,r)})}addUintVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateUintVector(e.length);if(!n)throw Error("Unable to allocate new unsigned int vector on heap.");for(const o of e)this.h._addUintVectorEntry(n,o);this.h._addUintVectorToInputSidePacket(n,r)})}addStringVectorToInputSidePacket(e,t){f(this,t,r=>{const n=this.h._allocateStringVector(e.length);if(!n)throw Error("Unable to allocate new string vector on heap.");for(const o of e)f(this,o,i=>{this.h._addStringVectorEntry(n,i)});this.h._addStringVectorToInputSidePacket(n,r)})}attachBoolListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachBoolListener(r)})}attachBoolVectorListener(e,t){ue(this,e,t),f(this,e,r=>{this.h._attachBoolVectorListener(r)})}attachIntListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachIntListener(r)})}attachIntVectorListener(e,t){ue(this,e,t),f(this,e,r=>{this.h._attachIntVectorListener(r)})}attachUintListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachUintListener(r)})}attachUintVectorListener(e,t){ue(this,e,t),f(this,e,r=>{this.h._attachUintVectorListener(r)})}attachDoubleListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachDoubleListener(r)})}attachDoubleVectorListener(e,t){ue(this,e,t),f(this,e,r=>{this.h._attachDoubleVectorListener(r)})}attachFloatListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachFloatListener(r)})}attachFloatVectorListener(e,t){ue(this,e,t),f(this,e,r=>{this.h._attachFloatVectorListener(r)})}attachStringListener(e,t){oe(this,e,t),f(this,e,r=>{this.h._attachStringListener(r)})}attachStringVectorListener(e,t){ue(this,e,t),f(this,e,r=>{this.h._attachStringVectorListener(r)})}attachProtoListener(e,t,r){oe(this,e,t),f(this,e,n=>{this.h._attachProtoListener(n,r||!1)})}attachProtoVectorListener(e,t,r){ue(this,e,t),f(this,e,n=>{this.h._attachProtoVectorListener(n,r||!1)})}attachAudioListener(e,t,r){this.h._attachAudioListener||console.warn('Attempting to use attachAudioListener without support for output audio. Is build dep ":gl_graph_runner_audio_out" missing?'),oe(this,e,(n,o)=>{n=new Float32Array(n.buffer,n.byteOffset,n.length/4),t(n,o)}),f(this,e,n=>{this.h._attachAudioListener(n,r||!1)})}finishProcessing(){this.h._waitUntilIdle()}closeGraph(){this.h._closeGraph(),this.h.simpleListeners=void 0,this.h.emptyPacketListeners=void 0}},class extends un{ja(){this.h._registerModelResourcesGraphService()}});var un;async function bo(e,t){const r=await(async(n,o,i)=>{var s=O;if(n&&await an(n),!self.ModuleFactory||o&&(await an(o),!self.ModuleFactory))throw Error("ModuleFactory not set.");return self.Module&&i&&((n=self.Module).locateFile=i.locateFile,i.mainScriptUrlOrBlob&&(n.mainScriptUrlOrBlob=i.mainScriptUrlOrBlob)),i=await self.ModuleFactory(self.Module||i),self.ModuleFactory=self.Module=void 0,new s(i,null)})(e.wasmLoaderPath,e.assetLoaderPath,{locateFile:n=>n.endsWith(".wasm")?e.wasmBinaryPath.toString():e.assetBinaryPath&&n.endsWith(".data")?e.assetBinaryPath.toString():n});return await r.N(t),r}async function Vt(e,t){return bo(e,t)}function cn(e){try{const t=e.J.length;if(t===1)throw Error(e.J[0].message);if(t>1)throw Error("Encountered multiple errors: "+e.J.map(r=>r.message).join(", "))}finally{e.J=[]}}function Ee(e,t){e.I=Math.max(e.I,t)}var Gt=class{constructor(e){this.j=e,this.J=[],this.I=0,this.j.setAutoRenderToScreen(!1)}setGraph(e,t){this.j.attachErrorListener((r,n)=>{this.J.push(Error(n))}),this.j.ja(),this.j.setGraph(e,t),cn(this)}finishProcessing(){this.j.finishProcessing(),cn(this)}close(){this.j.closeGraph()}};Gt.prototype.close=Gt.prototype.close;var Ae=class extends A{constructor(e){super(e)}j(){return me(R(this,2))??0}};function hn(e,t){te(e,1,t)}var vo=class extends A{constructor(e){super(e)}},fn=[0,Q,y,Nt,-1,$];function So(e,t,r,n){if(e.data!==void 0){var o=new Uint8Array(e.data.buffer,t,r);return n===1&&function(i,s,a){i.i.push([s,a]),i.i.sort((l,u)=>l[0]-u[0]),s=0;for(const[l,u]of i.i){const c=u;(a=l)<=s&&(s=Math.max(s,a+c))}s===i.length&&(i.data=void 0)}(e,t,r),o}}Ae.prototype.l=Ve(fn);class Eo{constructor(t){this.i=[],this.data=t,this.length=t.length}}function dn(e,t){return new Ao(async()=>{const{value:r,done:n}=await e.read();return n?void 0:r},t)}async function pn(e,t,r,n,o){if(o===2)return e.i=[],e.j=()=>Promise.resolve(void 0),setTimeout(()=>{e.l()},0),Promise.resolve(0);for(;e.size<r+n;){var i=await e.j();if(i===void 0)break;e.i.push(new Eo(i))}if(e.size<r+n)throw Error(`Data size is too small: ${e.size}, expected at least ${r+n}.`);i=t._malloc(n)>>>0;let s=0;for(let a=0;a<e.i.length;a++){const l=e.i[a];if(r>=l.length){r-=l.length;continue}const u=Math.min(n,l.length-r);if((r=So(l,r,u,o))===void 0)throw Error("Data has already been released.");if(t.HEAPU8.set(r,i+s),r=0,s+=u,(n-=u)===0)break}if(n!==0)throw Error("Data not found.");return Promise.resolve(i)}var Ao=class{constructor(e,t){this.i=[],this.j=e,this.l=t}get size(){let e=0;for(let t=0;t<this.i.length;t++)e+=this.i[t].length;return e}};function $e(e){return typeof e=="object"&&e!=null&&"imageSource"in e}function He(e){return typeof e=="object"&&e!=null&&"audioSource"in e}async function mn(e,t,r){e=new yn(e,r);let n=0;for(t=t.getReader();;){const{value:o,done:i}=await t.read();if(i)break;e.set(o,n),n+=o.byteLength}if(r!==n)throw gn(e),Error(`File could not be fully loaded to memory, so was not retained. Loaded ${n}/${r} bytes before failure`);return e}function gn(e){if(e.i)try{e.h._free(e.j)}catch{}finally{e.i=!1}}var yn=class{constructor(e,t){this.h=e,this.l=t,this.j=this.h._malloc(t)>>>0,this.o=this.h.HEAPU8,this.i=!!this.j}get offset(){if(!this.i)throw Error("WasmFileReference has been freed.");return this.j}get size(){if(!this.i)throw Error("WasmFileReference has been freed.");return this.l}set(e,t){this.o.set(e,this.j+(t??0))}},_n=class extends A{constructor(e){super(e)}};_n.prototype.j=Ve([0,N,2,M,y,S]);var To=class extends A{constructor(e){super(e)}},Io=class extends A{constructor(e){super(e)}},Po=class extends A{constructor(e){super(e)}},wn=class extends A{constructor(e){super(e)}},zt=[0,y,-6,1,y,1,[0,S,Q,-2],[0,S,Nt],Q,-2,[0,S,-1,Q,Nt,re,$,T,-1],1,S,y,$,-1,[0,Q,y],S,-1,mt,y,-5,mt,-1,[0,$,mt],$,T,[0,$,-2],mt,[0,y],[0,y,-4],T,$,-2,T],bn=[0,N,-2],vn=[0,[4,6],zt,y,1,fo,M,Wr,Rt,bn,$,[0,[0,y,-1,H,[0,y,[0,y,-1],-1,[0,Q,-1],S],S,-2,y,-1],[0,y,-1,S],zt,S,y,[0,y]],P,-3,[0,y,S],zt,[0,bn,-2],ve];wn.prototype.j=Ve([0,N,8,[0,S,-6],1,y,1,y,[0,H,[0,N,ho,-1,Q],vn,y],[0,y,S,-3],1,Q,1,vn,1,y,5,Q,ve,1,fn,S,y]);var Lo=class extends A{constructor(e){super(e)}},Sn=class extends A{constructor(e){super(e)}},yt=[2,4];Sn.prototype.j=Ve([0,yt,y,Wr,y,F,[0,1,N]]);const Oo=function(e){return class extends e{constructor(){super(...arguments),this.P=!1,this.F=this.H=0}M(){if(this.P)throw Error("Cannot process because LLM inference engine is currently loading or processing.");this.P=!0}L(){this.P=!1}async createLlmInferenceEngine(t,r){var n;this.M();try{const o=dn(t,()=>{});await this.h.createLlmInferenceEngine(k(r,2)??512,((n=Ne(r,Ae,3))==null?void 0:n.j())??40,ee(R(r,6))??!1??!1,k(r,7)??0,ee(R(r,8))??!1??!1,(i,s,a)=>pn(o,this.h,i,s,a))}finally{this.L()}}async aa(t,r){var n;this.M();try{await this.la(t),await this.h.ccall("CreateLlmInferenceEngineConverted","void",["number","number","boolean"],[k(r,2)??512,((n=Ne(r,Ae,3))==null?void 0:n.j())??40,ee(R(r,6))??!1??!1],{async:!0})}finally{this.L()}}V(){this.M();try{const t=this.h;t.ccall("DeleteLlmInferenceEngine","void",[],[],{async:!1}),this.H&&(t._FreeSession(this.H),this.F===this.H&&(this.F=0),this.H=0),this.F&&(t._FreeSession(this.F),this.F=0)}finally{this.L()}}async R(t,r,n){this.M();try{const o=[],i=this.h;i._userProgressListener=(d,m)=>{d&&o.push(d),n&&n(d,m)};const s=r.l(),a=s.length,l=this.h._malloc(a);this.h.HEAPU8.set(s,l);const u=t.some(He),c=t.some($e);i.ccallNum=i.ccall;const h=await i.ccallNum("MakeSessionForPredict","number",["number","number","boolean","boolean"],[l,a,c,u],{async:!0});r=[];for(const d of t)if(typeof d=="string")f(this,d,m=>{i._AddTextQueryChunk(h,m)});else if($e(d)){const{image:m,width:w,height:x}=await this.ea(d.imageSource),_=typeof OffscreenCanvas<"u"?new OffscreenCanvas(w,x):document.createElement("canvas");_.width=w,_.height=x;const E=_.getContext("2d");E.drawImage(m,0,0);const I=E.getImageData(0,0,w,x),V=this.h._malloc(I.width*I.height*4);this.h.HEAPU8.set(I.data,V),i._AddImageQueryChunk(h,V,I.width,I.height),r.push(V)}else{if(!He(d))throw Error("Unsupported PromptPart type in query.");{const m=await this.da(d.audioSource),w=this.h._malloc(m.audioSamples.byteLength);this.h.HEAPF32.set(m.audioSamples,w/4),i._AddAudioQueryChunk(h,m.audioSampleRateHz,w,m.audioSamples.length),r.push(w)}}await i.ccall("PredictSession","void",["number"],[h],{async:!0}),t=!0,c&&this.F===0&&(this.F=h,t=!1),u&&this.H===0&&(this.H=h,t=!1),t&&i._FreeSession(h);for(const d of r)this.h._free(d);return r.length=0,n&&n("",!0),this.h._free(l),i._userProgressListener=void 0,o.join("")}finally{this.L()}}S(t){this.M();let r=0,n="";for(const o of t)typeof o=="string"?n+=o:$e(o)?r+=260:He(o)&&console.warn("sizeInTokens is not yet implemented for audio; audio tokens will not be counted");try{let o;return f(this,n,i=>{o=this.h._GetSizeInTokens(i)}),r+o}finally{this.L()}}async la(t){t=await async function(r){const n=[];for(var o=0;;){const{done:i,value:s}=await r.read();if(i)break;n.push(s),o+=s.length}if(n.length===0)return new Uint8Array(0);if(n.length===1)return n[0];r=new Uint8Array(o),o=0;for(const i of n)r.set(i,o),o+=i.length;return r}(t);try{this.h.FS_unlink("llm.task")}catch{}this.h.FS_createDataFile("/","llm.task",t,!0,!1,!1)}async ea(t){if(typeof t=="string"){const r=new Image;r.src=t,r.crossOrigin="Anonymous";try{await r.decode()}catch{throw Error(`Image from URL ${t} failed to load`)}return{image:r,width:r.naturalWidth,height:r.naturalHeight}}if(t instanceof HTMLImageElement){try{await t.decode()}catch{throw Error("Image from HTMLImageElement failed to load")}return{image:t,width:t.naturalWidth,height:t.naturalHeight}}return t instanceof HTMLVideoElement?{image:t,width:t.videoWidth,height:t.videoHeight}:t instanceof VideoFrame?{image:t,width:t.displayWidth,height:t.displayHeight}:{image:t,width:t.width,height:t.height}}async da(t){if(typeof t=="string"){const r=await fetch(t);if(!r.ok)throw Error(`Audio fetch for ${t} had error: ${r.status}`);return t=await r.arrayBuffer(),{audioSamples:(t=await new AudioContext({sampleRate:16e3}).decodeAudioData(t)).getChannelData(0),audioSampleRateHz:t.sampleRate}}return typeof t=="object"&&t!=null&&"audioSamples"in t&&"audioSampleRateHz"in t?t:{audioSamples:t.getChannelData(0),audioSampleRateHz:t.sampleRate}}}}(function(e){return class Pn extends e{static async ka(r,n){let o;n||(n=await Pn.X());const i=[];for(const s of(r==null?void 0:r.requiredFeatures)??[])n.features.has(s)?i.push(s):console.warn(`WebGPU feature ${s} is not supported.`);r={...r,requiredFeatures:i};try{o=await n.requestDevice(r)}catch(s){throw console.error("Unable to initialize WebGPU with the requested features."),s}return(r=o).adapterInfo||(r.adapterInfo=n.info),o}static async X(r){if(!(r=await navigator.gpu.requestAdapter(r)))throw Error("Unable to request adapter from navigator.gpu; Ensure WebGPU is enabled.");return r}fa(r){if(n)typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement&&(n.id="canvas_webgpu");else var n=new OffscreenCanvas(1,1);n.getContext("webgpu").configure({device:r,format:navigator.gpu.getPreferredCanvasFormat()}),this.h.preinitializedWebGPUDevice=r}Z(){return this.h.ccall("closeGraph","void",[],[],{async:!0})}}}(function(e){return class extends e{addStreamingReaderToInputSidePacket(t,r){this.h.addStreamingReaderToInputSidePacket((n,o,i)=>pn(t,this.h,n,o,i),r)}}}(function(e){return class extends e{Y(t,r){f(this,"lora_model_ref_in",n=>{this.h._addRawDataSpanToInputStream(t.offset,t.size,n,r)})}}}(class extends wo{}))));class $t extends Oo{}var Ht=class{constructor(e){this.j=e,this.i=En,En++}},En=1;class xo{constructor(){let t,r;this.promise=new Promise((n,o)=>{t=n,r=o}),this.resolve=t,this.reject=r}}function An(e){return e===1?1:e+e%2}async function _t(){const e=await $t.X({powerPreference:"high-performance"});var t=e.limits.maxBufferSize,r=e.limits.maxStorageBufferBindingSize;return t<524550144&&console.warn(`This WebGPU device is unable to execute most LLM tasks, because the required maxBufferSize is usually at least 524550144, but your device only supports maxBufferSize of ${t}`),r<524550144&&console.warn(`The WebGPU device is unable to execute LLM tasks, because the required maxStorageBufferBindingSize is usually at least 524550144, but your device only supports maxStorageBufferBindingSize of ${r}`),t={requiredFeatures:["shader-f16"],requiredLimits:{maxStorageBufferBindingSize:r,maxBufferSize:t,maxStorageBuffersPerShaderStage:e.limits.maxStorageBuffersPerShaderStage}},e.features.has("subgroups")&&(console.warn("Experimental Chromium WGSL subgroup support detected. Enabling this feature in the inference engine."),r=["shader-f16","subgroups"],e.features.has("subgroups-f16")&&r.push("subgroups-f16"),t.requiredFeatures=r),$t.ka(t,e)}function Te(e){if(e.D.length>0){const t=[...e.D];if(e.D.length=0,!e.o)throw t;e.o.reject(t),e.o=void 0}}function ko(e){var n;const t=function(o){const i=new tn;p(i,10,"text_in"),p(i,10,"token_cost_in"),p(i,10,"lora_model_id_to_apply_in"),p(i,10,"lora_model_ref_in"),p(i,10,"lora_model_id_to_load_in"),p(i,16,"streaming_reader"),p(i,15,"text_out"),p(i,15,"text_end"),p(i,15,"token_cost_out");var s=new Z;j(s,2,"TokenizerInputBuildCalculator"),p(s,3,"PROMPT:text_in"),p(s,3,"LORA_ID:lora_model_id_to_apply_in"),p(s,4,"prompt"),ne(i,s),j(s=new Z,2,"ModelDataCalculator"),p(s,6,"MODEL_DATA:__side_packet_1"),p(s,6,"MODEL_TYPE:model_type"),p(s,5,"READ_DATA_FN:streaming_reader"),p(s,3,"LORA_MODEL_SPAN:lora_model_ref_in"),p(s,3,"LORA_MODEL_ID:lora_model_id_to_load_in"),p(s,4,"LORA_DATA:lora_model_data"),ne(i,s),j(s=new Z,2,"Gpt2UnicodeMappingCalculator"),p(s,5,"MODEL_TYPE:model_type"),p(s,6,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),ne(i,s),j(s=new Se,1,"type.googleapis.com/odml.infra.proto.TokenizerCalculatorOptions");var a=new Sn,l=k(o.i,2);q(a,1,l),j(l=new Lo,2,"spm_vocab_model"),l=Or(l);e:{ge(a);var u=a.m,c=0|u[g];if(l==null){var h=Pr(u);if(Lr(h,u,c)!==4)break e;h.set(yt,0)}else{const d=Pr(h=u),m=Lr(d,h,c);m!==4&&(m&&(c=W(h,c,m)),d.set(yt,4))}W(u,c,4,l)}return l&&!z(l)&&ye(a.m),q(a,3,2),Ct(s,a.j()),j(a=new Z,2,"TokenizerCalculator"),Re(a,8,Se,s),p(a,5,"MODEL_DATA:__side_packet_1"),p(a,3,"PROMPT_AND_INPUT_OPTIONS:prompt"),p(a,5,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),p(a,6,"PROCESSOR_GETTER:__input_side_1"),p(a,4,"IDS_AND_INPUT_OPTIONS:__stream_0"),ne(i,a),j(s=new Se,1,"type.googleapis.com/odml.infra.proto.LlmGpuCalculatorOptions"),q(a=new wn,12,3),j(a,1,"llm.tflite"),q(a,14,0),l=An(k(o.i,5)),q(a,22,l),l=Ne(o.i,Ae,3),te(a,31,l),C(l=new To,1,ie(!0),!1),ee(R(o.i,6))!=null&&(ee(R(o.i,6))??!1)&&C(l,1,ie(!1),!1),C(l,2,ie(!0),!1),C(l,5,ie(!0),!1),te(a,10,l),l=Sr(o.i,4,me,Rn===void 0?2:4),Ir(a,29,l),l=new Po,q(u=new Io,1,1),h=k(o.i,2),q(u,2,h),te(l,1,u),te(a,20,l),Ct(s,a.j()),j(a=new Z,2,"LlmGpuCalculator"),Re(a,8,Se,s),p(a,3,"IDS_AND_INPUT_OPTIONS:__stream_0"),p(a,3,"FINISH:finish"),p(a,3,"LORA_DATA:lora_model_data"),p(a,5,"MODEL_DATA:__side_packet_1"),p(a,4,"DECODED_IDS:__stream_3"),p(a,4,"OUTPUT_END:__stream_4"),j(s=new Xr,1,"FINISH"),C(s,2,ie(!0),!1),Re(a,13,Xr,s),ne(i,a),j(s=new Z,2,"IsPacketPresentCalculator"),p(s,3,"__stream_4"),p(s,4,"text_end"),ne(i,s),j(s=new Se,1,"type.googleapis.com/odml.infra.proto.DetokenizerCalculatorOptions"),a=new _n,o=An(k(o.i,5)),q(a,5,o),p(a,4,"<eos>"),p(a,4,"<|endoftext|>"),Ct(s,a.j()),j(o=new Z,2,"DetokenizerCalculator"),Re(o,8,Se,s),p(o,3,"IDS_AND_INPUT_OPTIONS:__stream_3"),p(o,5,"PROCESSOR_GETTER:__input_side_1"),p(o,5,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),p(o,5,"MODEL_DATA:__side_packet_1"),p(o,4,"FINISH_AND_INPUT_OPTIONS:finish"),p(o,4,"WORDS:text_out"),ne(i,o),j(o=new Z,2,"TokenCostCalculator"),p(o,3,"PROMPT:token_cost_in"),p(o,5,"PROCESSOR_GETTER:__input_side_1"),p(o,5,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),p(o,4,"NUM_TOKENS:token_cost_out"),ne(i,o),i}(e);e.j.attachStringVectorListener("text_out",(o,i)=>{o=function(s,a){return s==null||s.length===0?[]:s.map(l=>(l=(l=l.replaceAll("‚ñÅ"," ")).replaceAll("<0x0A>",`
`),a&&(l=l.trimStart()),l.split("\\[eod\\]",1)[0]))}(o,e.G.length===0),o.forEach((s,a)=>{a<k(e.i,5)&&e.G[a].push(s)}),e.v&&e.D.length===0&&(e.A?(o.length>k(e.i,5)&&o.pop(),e.v(o,!1)):e.v(o[0],!1)),Ee(e,i)}),e.j.attachEmptyPacketListener("text_out",o=>{Ee(e,o)}),e.j.attachBoolListener("text_end",(o,i)=>{Ee(e,i);try{Te(e)}catch(s){throw e.l=!1,s}if(e.o&&(e.o.resolve(e.G.map(s=>s.join(""))),e.o=void 0),e.v)if(e.A){for(o=[],i=0;i<k(e.i,5);i++)o.push("");e.v(o,!0)}else e.v("",!0);e.l=!1,e.A=void 0}),e.j.attachEmptyPacketListener("text_end",o=>{e.l=!1,e.A=void 0,Ee(e,o),Te(e),e.o&&(e.o.resolve(e.G.map(i=>i.join(""))),e.o=void 0)}),e.j.attachIntListener("token_cost_out",(o,i)=>{e.T=o,Ee(e,i)}),e.U&&e.j.addStreamingReaderToInputSidePacket(e.U,"streaming_reader");const r=t.j();return(n=e.C)==null||n.removeEventListener("uncapturederror",e.K),e.j.Z().then(()=>{var o;(o=e.C)==null||o.addEventListener("uncapturederror",e.K),e.D.length=0,e.setGraph(new Uint8Array(r),!0),e.finishProcessing()})}function Tn(e,t,r,n){if(e.v=typeof r=="function"?r:n,(n=(t=Array.isArray(t)?t:[t]).filter(o=>$e(o)).length)>0&&(et(R(e.i,7))==null||k(e.i,7)<n))throw Error(`maxNumImages is set to ${et(R(e.i,7))!=null?k(e.i,7):0}, but the query included ${n} images.`);if((n=t.filter(o=>He(o)).length)>0&&(ee(R(e.i,8))==null||!ee(R(e.i,8))))throw Error(`supportAudio was not enabled, but the query included ${n} audio chunks.`);if(e.B){if(e.A&&k(e.i,5)>1)throw Error("Multi-response generation is not supported for converted LLM models (.task format) yet, nor is it supported for multimodality. Please use the .bin format without multimodality or request only one response.");if(r instanceof Ht)throw Error("LoRA is not supported for converted LLM models (.task format) yet, nor is it supported for multimodality. Please use the .bin format without multimodality to use LoRA.");return e.j.R(t,e.u,(o,i)=>{e.D.length===0&&e.v&&(e.A?e.v([o],i):e.v(o,i))}).then(o=>(Te(e),[o]))}if(e.l)throw Error("Previous invocation or loading is still ongoing.");for(e.l=!0,e.G.length=0,n=0;n<k(e.i,5);n++)e.G[n]=[];if(n=e.I+1,e.j.addStringToStream(t.join(""),"text_in",n),r instanceof Ht){if(r.j!==e)throw e.l=!1,e.A=void 0,Error("The LoRA model was not loaded by this LLM Inference task.");e.j.addUintToStream(r.i,"lora_model_id_to_apply_in",n)}else e.j.addEmptyPacketToStream("lora_model_id_to_apply_in",n);return e.finishProcessing(),e.o=new xo,e.o.promise}var O=class extends Gt{constructor(e,t){if(super(new $t(e,t)),this.G=[],this.O=this.B=this.l=!1,this.D=[],this.K=r=>{if((r=r.error).message.match(/exceeds the max buffer size limit/))throw Error(`Failed to run this LLM model because it requires a buffer size that exceeds the maximum size your device supports, but you could try a smaller LLM model or different device.
WebGPU throws: "${r.message}"`);if(r.message.match(/is larger than the maximum storage buffer binding size/))throw Error(`Failed to run this LLM model because it requires a storage buffer binding size that exceeds the maximum size your device supports, but you could try a smaller LLM model or different device.
WebGPU throws: "${r.message}"`);this.D.push(r)},this.i=new vo,hn(this.i,new rn),this.u=new Ae,te(this.i,3,this.u),Ce(this.i,2,512),e=this.u,!pe(2))throw xe("enum");C(e,1,2,0),q(this.u,2,40),C(this.u,3,Tt(1),0),se(this.u,5,It(0)),C(this.u,4,Tt(.8),0),Ce(this.i,5,1)}async N(e){var s,a,l,u,c,h,d;if(this.l)throw Error("Cannot set options while loading or processing.");if((s=e.baseOptions)!=null&&s.modelAssetPath&&((a=e.baseOptions)!=null&&a.modelAssetBuffer))throw Error("Cannot set both baseOptions.modelAssetPath and baseOptions.modelAssetBuffer");let t;const r=new Promise(m=>{t=m});if((l=e.baseOptions)!=null&&l.modelAssetPath){var n=await fetch(e.baseOptions.modelAssetPath.toString());if(!n.ok)throw Error(`Failed to fetch model: ${e.baseOptions.modelAssetPath} (${n.status})`);if(!n.body)throw Error(`Failed to fetch model: ${e.baseOptions.modelAssetPath} (no body)`);n=n.body.getReader()}else((u=e.baseOptions)==null?void 0:u.modelAssetBuffer)instanceof Uint8Array?n=function(m){return new ReadableStream({start(){},async pull(w){w.enqueue(m),w.close()}})}(e.baseOptions.modelAssetBuffer).getReader():((c=e.baseOptions)==null?void 0:c.modelAssetBuffer)instanceof ReadableStreamDefaultReader?(n=e.baseOptions.modelAssetBuffer,e.baseOptions.modelAssetBuffer=void 0):t();if(!n)throw Error("No model asset provided.");{const[m,w]=on(n);this.O=await async function(x){const _=[];let E;for(const[V,Wt]of yo){const Do=V;var I=Wt;[x,E]=on(x),I=await I(E),await E.cancel(),I&&_.push(Do)}if(await x.cancel(),_.length===0)throw Error("No model format matched.");if(_.length===1)return _[0];throw Error(`Multiple model formats matched: ${_}`)}(w)===1;var o="maxNumImages"in e&&e.maxNumImages?e.maxNumImages:0;Ce(this.i,7,o);var i="supportAudio"in e&&!!e.supportAudio;se(this.i,8,ie(i)),this.O||o>0||i?(this.B=!0,n=m):(this.B=!1,this.U=dn(m,t))}if((d=(h=e.baseOptions)==null?void 0:h.gpuOptions)!=null&&d.device&&(this.C&&this.C.removeEventListener("uncapturederror",this.K),this.C=e.baseOptions.gpuOptions.device,this.j.fa(this.C),this.C.addEventListener("uncapturederror",this.K)),"maxTokens"in e&&Ce(this.i,2,e.maxTokens??512),"topK"in e&&q(this.u,2,e.topK??40),"temperature"in e&&C(this.u,4,Tt(e.temperature??.8),0),"randomSeed"in e&&se(this.u,5,It(e.randomSeed??0)),"loraRanks"in e&&function(m,w){Ir(m,4,w)}(this.i,e.loraRanks??[]),"numResponses"in e){if((o=e.numResponses??1)<1)throw Error("'numResponses' must be at least 1.");if(this.B&&o>1)throw Error("'numResponses > 1' is not supported for converted LLM models yet, and is also not supported with multimodality.");Ce(this.i,5,o),i=Ne(this.i,Ae,3),o>1&&i&&(i.j()<=1||(R(i,4,dr)??0)<=0)&&console.warn("To generate multiple responses, it is expected topK > 1 and temperature > 0; otherwise, all the generated responses may be the same.")}return"forceF32"in e&&e.forceF32!==void 0&&se(this.i,6,ie(e.forceF32)),this.B?(this.j.V(),this.O?this.j.aa(n,this.i).then(()=>{Te(this)}):this.j.createLlmInferenceEngine(n,this.i).then(()=>{Te(this)})):(this.l=!0,e=ko(this).then(()=>{}),Promise.all([r,e]).then(()=>{this.l=!1,Te(this)}))}get baseOptions(){return Ne(this.i,rn,1)}set baseOptions(e){hn(this.i,e)}get isIdle(){return!this.l&&!this.o}R(e,t,r){return k(this.i,5)>1&&console.warn("'numResponses' is set larger than 1 and this function only returns the first response, so we recommend either using 'generateResponses()' to obtain multiple responses, or else setting 'numResponses' to 1 for better performance."),this.A=!1,Tn(this,e,t,r).then(n=>n[0])}ca(e,t,r){return this.A=!0,Tn(this,e,t,r)}S(e){if(e=Array.isArray(e)?e:[e],this.B)return this.j.S(e);if(this.l)throw Error("Previous invocation or loading is still ongoing.");if(e.some($e))throw Error("sizeInTokens requires maxNumImages > 0 for images.");if(e.some(He))throw Error("sizeInTokens requires supportAudio for audio.");return e=e.join(""),this.l=!0,this.T=void 0,this.j.addStringToStream(e,"token_cost_in",this.I+1),this.finishProcessing(),this.l=!1,this.T}async ia(e){if(this.B)throw Error("LoRA is not supported for converted LLM models (.task format) yet, nor is it supported for multimodality. Please use the old format (.bin) without multimodality to use LoRA.");if(this.l)throw Error("Cannot load LoRA model while loading or processing.");if(this.l=!0,e instanceof Uint8Array){var t=new yn(this.j.h,e.length);t.set(e),e=t}else e=e instanceof Blob?await async function(n,o){return mn(n,o.stream(),o.size)}(this.j.h,e):await async function(n,o){o=await fetch(o.toString());const i=Number(o.headers.get("content-length"));if(!o.body)throw Error("Response body is not available.");if(!i)throw Error("File size is 0.");return mn(n,o.body,i)}(this.j.h,e);t=new Ht(this);const r=this.I+1;return this.j.Y(e,r),this.j.addUintToStream(t.i,"lora_model_id_to_load_in",r),this.finishProcessing(),gn(e),Ee(this,r),this.l=!1,t}close(){var e;this.B&&this.j.V(),(e=this.C)==null||e.removeEventListener("uncapturederror",this.K),super.close()}};if(O.prototype.loadLoraModel=O.prototype.ia,O.prototype.sizeInTokens=O.prototype.S,O.prototype.generateResponses=O.prototype.ca,O.prototype.generateResponse=O.prototype.R,O.prototype.setOptions=O.prototype.N,O.createWebGpuDevice=_t,O.createFromModelPath=async function(e,t){return Vt(e,t={baseOptions:{gpuOptions:{device:await _t()},modelAssetPath:t}})},O.createFromModelBuffer=async function(e,t){return Vt(e,t={baseOptions:{gpuOptions:{device:await _t()},modelAssetBuffer:t}})},O.createFromOptions=async function(e,t){var r,n,o;if(!((n=(r=t.baseOptions)==null?void 0:r.gpuOptions)!=null&&n.device)){const i=await _t();t.baseOptions=t.baseOptions??{},t.baseOptions.gpuOptions=((o=t==null?void 0:t.baseOptions)==null?void 0:o.gpuOptions)??{},t.baseOptions.gpuOptions.device=i}return Vt(e,t)},self.exports={},typeof self.HTMLImageElement>"u"&&(self.HTMLImageElement=class{}),typeof self.Image>"u"&&(self.Image=self.HTMLImageElement),typeof self.HTMLVideoElement>"u"&&(self.HTMLVideoElement=class{}),typeof self.AudioContext>"u"){const e=(r,n,o)=>{let i="";for(let s=0;s<o;s++)i+=String.fromCharCode(r.getUint8(n+s));return i};class t{constructor(n){Pe(this,"sampleRate");Pe(this,"length");Pe(this,"duration");Pe(this,"numberOfChannels");Pe(this,"channels");var o;this.sampleRate=n.sampleRate,this.numberOfChannels=n.numberOfChannels,this.channels=n.pcmData,this.length=((o=this.channels[0])==null?void 0:o.length)||0,this.duration=this.length/this.sampleRate}getChannelData(n){if(n>=this.numberOfChannels)throw new Error(`Invalid channel index ${n}.`);return this.channels[n]}}self.AudioContext=class{decodeAudioData(n){return new Promise((o,i)=>{try{const s=new DataView(n);if(e(s,0,4)!=="RIFF"||e(s,8,4)!=="WAVE")return i(new DOMException("Invalid WAV file header","DataCloneError"));let a=-1,l=-1,u=0,c=12;for(;c<s.byteLength;){const _=e(s,c,4),E=s.getUint32(c+4,!0);_==="fmt "?a=c+8:_==="data"&&(l=c+8,u=E),c+=8+E}if(a===-1||l===-1)return i(new DOMException("Could not find fmt and data chunks in WAV file","DataCloneError"));const h=s.getUint16(a+2,!0),d=s.getUint32(a+4,!0),m=s.getUint16(a+14,!0);if(m!==16)return i(new DOMException(`Unsupported bitsPerSample: ${m}. Only 16-bit PCM is supported.`,"NotSupportedError"));const w=Array.from({length:h},()=>new Float32Array(u/(h*(m/8)))),x=u/(m/8);for(let _=0;_<x;_++){const E=l+_*(m/8),I=_%h,V=Math.floor(_/h),Wt=s.getInt16(E,!0);w[I][V]=Wt/32768}o(new t({sampleRate:d,numberOfChannels:h,pcmData:w}))}catch(s){i(s)}})}}}typeof self.OfflineAudioContext>"u"&&(self.OfflineAudioContext=self.AudioContext);const Uo="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-genai@0.10.25/wasm";let B=null,Ie=null;const jo=async e=>{const{modelBlob:t,modelSource:r,options:n}=e;B&&(await B.close(),B=null);try{if(!("gpu"in navigator))throw new Error("WebGPU is not supported.");if(!t)throw new Error(`Model data for ${r} not found.`);const o=URL.createObjectURL(t),i=await le.forGenAiTasks(Uo),{maxTokens:s=4096,topK:a=40,temperature:l=.3,randomSeed:u=101,supportAudio:c=!1,maxNumImages:h=1}=n;B=await O.createFromOptions(i,{baseOptions:{modelAssetPath:o,delegate:"GPU"},maxTokens:s,topK:a,temperature:l,randomSeed:u,supportAudio:c,maxNumImages:h}),URL.revokeObjectURL(o),self.postMessage({type:"init_done",payload:{modelIdentifier:r}})}catch(o){B=null;const i=o instanceof Error?o.message:"Unknown initialization error.";self.postMessage({type:"init_error",payload:{error:i}})}},Mo=async()=>{B&&(console.log("Unloading offline model from inference worker..."),await B.close(),B=null,console.log("Offline model unloaded successfully.")),self.postMessage({type:"unload_done"})},In=(e,t,r,n)=>{if(!B)throw new Error("Offline model is not initialized.");Ie=new AbortController;const o=Ie.signal;return new Promise((i,s)=>{const a=()=>s(new DOMException("Translation cancelled.","AbortError"));o.addEventListener("abort",a,{once:!0});const l=performance.now();let u=null,c=null;try{let h="";const d=(x,_)=>{if(!o.aborted){if(u===null&&x){const E=performance.now();u=E-l,c=E,console.log(`[Perf] Prefill: ${u.toFixed(2)} ms`)}if(h+=x,n&&self.postMessage({type:"translation_chunk",payload:{chunk:x}}),_){const E=performance.now();if(c){const I=E-c,V=h.length/(I/1e3);console.log(`[Perf] Decoding: ${V.toFixed(2)} chars/sec (${h.length} chars in ${I.toFixed(2)} ms)`)}else u&&console.log(`[Perf] Single-chunk response received in ${u.toFixed(2)} ms.`);o.removeEventListener("abort",a),i(h.trim())}}},w=`Translate the following ${t==="Auto Detect"?"auto-detect the source language":`from ${t}`} text into concise ${r}: "${e}". 
 Provide *only* the translated text. Do not include any additional explanations, commentary, or greetings.`;B.generateResponse(w,d)}catch(h){o.removeEventListener("abort",a),s(h)}})},Bo=async e=>{if(!B)return self.postMessage({type:"extract_text_error",payload:{error:"Offline model not initialized."}});const{imageBitmap:t}=e,r="Extract all text from the following image. Return only the extracted text without any extra comments or explanations.";try{const n=await B.generateResponse([`<start_of_turn>user
${r}
`,{imageSource:t},`<end_of_turn>
<start_of_turn>model
`]);t.close(),self.postMessage({type:"extract_text_done",payload:{text:n.trim()}})}catch(n){console.error("OCR Worker Error:",n);const o=n instanceof Error?n.message:"Offline image text extraction failed.";self.postMessage({type:"extract_text_error",payload:{error:o}})}},No=async e=>{if(!B)return self.postMessage({type:"transcribe_error",payload:{error:"Offline model not initialized."}});const{audioData:t,sourceLang:r}=e;let n=null;try{n=URL.createObjectURL(t);const i=`Transcribe the following audio. ${r==="Auto Detect"?"Auto-detect the language.":`The language is ${r}.`}  Return only the transcribed text.`,s=await B.generateResponse([`<start_of_turn>user
 ${i} <end_of_turn>
<start_of_turn>model
`,{audioSource:n}]);(!s||s.trim()==="")&&console.warn("Model returned an empty response for transcription."),self.postMessage({type:"transcribe_done",payload:{text:s.trim()}})}catch(o){console.error("Transcription Internal Error:",o);const i=o instanceof Error?o.message:"Offline audio transcription failed.";self.postMessage({type:"transcribe_error",payload:{error:i}})}finally{n&&URL.revokeObjectURL(n)}};self.onmessage=async e=>{const{type:t,payload:r}=e.data;try{switch(t){case"init":await jo(r);break;case"unload":await Mo();break;case"translate_stream":{const n=await In(r.text,r.sourceLang,r.targetLang,!0);self.postMessage({type:"translation_done",payload:{result:n}});break}case"translate_full":{const n=await In(r.text,r.sourceLang,r.targetLang,!1);self.postMessage({type:"translation_full_done",payload:{result:n}});break}case"cancel_task":Ie==null||Ie.abort();break;case"extractText":await Bo(r);break;case"transcribe":await No(r);break;default:console.warn(`Unknown inference worker message type: ${t}`)}}catch(n){const o=n instanceof DOMException&&n.name==="AbortError",i=t.replace("_stream","").replace("_full","");if(o)self.postMessage({type:"translation_cancelled"});else{const s=n instanceof Error?n.message:`Unknown error in ${t}.`;self.postMessage({type:`${i}_error`,payload:{error:s}})}}finally{Ie=null}}})();
