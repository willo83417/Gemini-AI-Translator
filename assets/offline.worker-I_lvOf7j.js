(function(){"use strict";let a=null,e=null;const i=()=>{a||(a=new Worker(new URL("/Gemini-AI-Translator-offline/assets/worker-B6BDErf7.js",self.location.href)),a.onmessage=r=>{const{type:t,payload:n}=r.data;if(e&&t==="translation_full_done"){e.resolve(n.result),e=null;return}if(e&&t==="translation_error"){e.reject(new Error(n.error)),e=null;return}self.postMessage(r.data)},a.onerror=r=>{const t=`Inference worker error: ${r.message}`;e&&(e.reject(new Error(t)),e=null),self.postMessage({type:"init_error",payload:{error:t}})})},o=()=>(i(),a),c=async r=>{const{text:t,sourceLang:n,targetLang:f,sourceLangCode:p,targetLangCode:u,isTwoStepEnabled:d}=r,w=p==="ja"&&u.startsWith("zh");if(d&&w)try{const s=await new Promise((y,m)=>{e={originalPayload:r,resolve:y,reject:m},o().postMessage({type:"translate_full",payload:{text:t,sourceLang:"Japanese",targetLang:"English"}})});if(!(s!=null&&s.trim()))throw new Error("Intermediate English translation failed (result was empty).");o().postMessage({type:"translate_stream",payload:{text:s,sourceLang:"English",targetLang:f}})}catch(l){const s=l instanceof Error?l.message:"Two-step translation failed.";self.postMessage({type:"translation_error",payload:{error:s}}),e=null}else o().postMessage({type:"translate_stream",payload:r})},g=()=>{e&&(e.reject(new DOMException("Translation cancelled.","AbortError")),e=null),a&&a.postMessage({type:"cancel_task"})};self.onmessage=async r=>{const{type:t,payload:n}=r.data;switch(t!=="init"&&!a&&i(),t){case"init":case"unload":case"extractText":case"transcribe":o().postMessage(r.data);break;case"translate":await c(n);break;case"cancel_translation":g();break;default:console.warn(`Unknown controller worker message type: ${t}`)}}})();
