(function(){"use strict";let e=null,r=null;const c=a=>{if(!e){console.error("Inference worker does not exist. Cannot process message:",a.data.type),self.postMessage({type:"error",payload:{error:"Inference worker is not initialized."}});return}a.data.type==="extractText"&&a.data.payload.imageBitmap?e.postMessage(a.data,[a.data.payload.imageBitmap]):e.postMessage(a.data)},f=async a=>{const{text:n,sourceLang:p,targetLang:s,sourceLangCode:t,targetLangCode:l,isTwoStepEnabled:g}=a,w=t==="ja"&&l.startsWith("zh");if(g&&w)try{const o=await new Promise((y,m)=>{if(r={resolve:y,reject:m},!e)throw new Error("Inference worker not available for two-step translation.");e.postMessage({type:"translate_full",payload:{text:n,sourceLang:"Japanese",targetLang:"English"}})});if(!(o!=null&&o.trim()))throw new Error("Intermediate English translation failed.");if(!e)throw new Error("Inference worker not available for second step of translation.");e.postMessage({type:"translate_stream",payload:{text:o,sourceLang:"English",targetLang:s}})}catch(i){const o=i instanceof Error?i.message:"Two-step translation failed.";self.postMessage({type:"translation_error",payload:{error:o}}),r=null}else{if(!e){self.postMessage({type:"translation_error",payload:{error:"Inference worker not ready."}});return}e.postMessage({type:"translate_stream",payload:a})}},d=()=>{r&&(r.reject(new DOMException("Translation cancelled.","AbortError")),r=null),e&&e.postMessage({type:"cancel_task"})};self.onmessage=async a=>{const{type:n,payload:p}=a.data;switch(n){case"init":e&&e.terminate(),e=new Worker(new URL("/Gemini-AI-Translator/assets/worker-7SXC4Vlz.js",self.location.href)),e.onmessage=s=>{const{type:t,payload:l}=s.data;r&&t==="translation_full_done"?(r.resolve(l.result),r=null):r&&(t==="translation_error"||t==="error")?(r.reject(new Error(l.error)),r=null):self.postMessage(s.data)},e.onerror=s=>{const t=`Inference worker error: ${s.message}`;r&&(r.reject(new Error(t)),r=null),self.postMessage({type:"init_error",payload:{error:t}})},c(a);break;case"unload":e&&(e.terminate(),e=null,console.log("Inference worker terminated and resources released.")),self.postMessage({type:"unload_done"});break;case"transcribe":case"extractText":c(a);break;case"translate":await f(p);break;case"cancel_translation":d();break;default:console.warn(`Unknown controller worker message type: ${n}`)}}})();
