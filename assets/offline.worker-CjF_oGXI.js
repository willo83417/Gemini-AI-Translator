(function(){"use strict";let e=null,a=null;const i=()=>{e&&(e.onmessage=r=>{const{type:o,payload:s}=r.data;a&&o==="translation_full_done"?(a.resolve(s.result),a=null):a&&(o==="translation_error"||o==="error")?(a.reject(new Error(s.error)),a=null):self.postMessage(r.data)},e.onerror=r=>{const o=`Inference worker error: ${r.message}`;console.error("Controller received an error from inference worker:",r),a&&(a.reject(new Error(o)),a=null),self.postMessage({type:"init_error",payload:{error:o}})})},l=r=>{if(!e){console.error("Inference worker does not exist. Cannot process message:",r.data.type),self.postMessage({type:"error",payload:{error:"Inference worker is not initialized."}});return}r.data.type==="extractText"&&r.data.payload.imageBitmap?e.postMessage(r.data,[r.data.payload.imageBitmap]):e.postMessage(r.data)},c=async r=>{const{text:o,sourceLang:s,targetLang:p,sourceLangCode:d,targetLangCode:g,isTwoStepEnabled:w}=r,y=d==="ja"&&g.startsWith("zh");if(w&&y)try{const t=await new Promise((m,u)=>{if(a={resolve:m,reject:u},!e)throw new Error("Inference worker not available for two-step translation.");e.postMessage({type:"translate_full",payload:{text:o,sourceLang:"Japanese",targetLang:"English"}})});if(!(t!=null&&t.trim()))throw new Error("Intermediate English translation failed.");if(!e)throw new Error("Inference worker not available for second step of translation.");e.postMessage({type:"translate_stream",payload:{text:t,sourceLang:"English",targetLang:p}})}catch(n){const t=n instanceof Error?n.message:"Two-step translation failed.";self.postMessage({type:"translation_error",payload:{error:t}}),a=null}else{if(!e){self.postMessage({type:"translation_error",payload:{error:"Inference worker not ready."}});return}e.postMessage({type:"translate_stream",payload:r})}},f=()=>{a&&(a.reject(new DOMException("Translation cancelled.","AbortError")),a=null),e&&e.postMessage({type:"cancel_task"})};self.onmessage=async r=>{const{type:o,payload:s}=r.data;switch(o){case"init":e||(console.log("Controller: Creating inference worker..."),e=new Worker(new URL("/Gemini-AI-Translator/assets/worker-COJ8MmvF.js",self.location.href)),i()),l(r);break;case"unload":e&&(console.log("Controller: Received unload command. Terminating inference worker to release VRAM."),e.terminate(),e=null),self.postMessage({type:"unload_done"});break;case"transcribe":case"extractText":l(r);break;case"translate":await c(s);break;case"cancel_translation":f();break;default:console.warn(`Unknown controller worker message type: ${o}`)}}})();
