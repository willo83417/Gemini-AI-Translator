(function(){"use strict";let e=null,a=null;const l=()=>{e&&(e.onmessage=r=>{const{type:t,payload:n}=r.data;a&&t==="translation_full_done"?(a.resolve(n.result),a=null):a&&(t==="translation_error"||t==="error")?(a.reject(new Error(n.error)),a=null):self.postMessage(r.data)},e.onerror=r=>{const t=`Inference worker error: ${r.message}`;console.error("Controller received an error from inference worker:",r),a&&(a.reject(new Error(t)),a=null),self.postMessage({type:"init_error",payload:{error:t}})})};console.log("Controller: Initializing and creating the first inference worker instance."),l();const i=r=>{if(!e){console.error("Inference worker does not exist. Cannot process message:",r.data.type),self.postMessage({type:"error",payload:{error:"Inference worker is not initialized."}});return}r.data.type==="extractText"&&r.data.payload.imageBitmap?e.postMessage(r.data,[r.data.payload.imageBitmap]):e.postMessage(r.data)},c=async r=>{const{text:t,sourceLang:n,targetLang:p,sourceLangCode:d,targetLangCode:g,isTwoStepEnabled:w}=r,y=d==="ja"&&g.startsWith("zh");if(w&&y)try{const o=await new Promise((m,u)=>{if(a={resolve:m,reject:u},!e)throw new Error("Inference worker not available for two-step translation.");e.postMessage({type:"translate_full",payload:{text:t,sourceLang:"Japanese",targetLang:"English"}})});if(!(o!=null&&o.trim()))throw new Error("Intermediate English translation failed.");if(!e)throw new Error("Inference worker not available for second step of translation.");e.postMessage({type:"translate_stream",payload:{text:o,sourceLang:"English",targetLang:p}})}catch(s){const o=s instanceof Error?s.message:"Two-step translation failed.";self.postMessage({type:"translation_error",payload:{error:o}}),a=null}else{if(!e){self.postMessage({type:"translation_error",payload:{error:"Inference worker not ready."}});return}e.postMessage({type:"translate_stream",payload:r})}},f=()=>{a&&(a.reject(new DOMException("Translation cancelled.","AbortError")),a=null),e&&e.postMessage({type:"cancel_task"})};self.onmessage=async r=>{const{type:t,payload:n}=r.data;switch(t){case"init":e||(console.log("Controller: Recreating inference worker after it was terminated."),e=new Worker(new URL("/Gemini-AI-Translator/assets/worker-7SXC4Vlz.js",self.location.href),{type:"classic"}),l()),i(r);break;case"unload":e&&(console.log("Controller: Received unload command. Terminating inference worker to release VRAM."),e.terminate(),e=null),self.postMessage({type:"unload_done"});break;case"transcribe":case"extractText":i(r);break;case"translate":await c(n);break;case"cancel_translation":f();break;default:console.warn(`Unknown controller worker message type: ${t}`)}}})();
