(function(){"use strict";let r=null,a=null;const i=()=>{r&&(r.onmessage=e=>{const{type:o,payload:t}=e.data;a&&o==="translation_full_done"?(a.resolve(t.result),a=null):a&&(o==="translation_error"||o==="error")?(a.reject(new Error(t.error)),a=null):self.postMessage(e.data)},r.onerror=e=>{const o=`Inference worker error: ${e.message}`;console.error("Controller received an error from inference worker:",e),a&&(a.reject(new Error(o)),a=null),self.postMessage({type:"init_error",payload:{error:o}})})},l=e=>{if(!r){console.error("Inference worker does not exist. Cannot process message:",e.data.type),self.postMessage({type:"error",payload:{error:"Inference worker is not initialized."}});return}e.data.type==="extractText"&&e.data.payload.imageBitmap?r.postMessage(e.data,[e.data.payload.imageBitmap]):r.postMessage(e.data)},c=async e=>{const{text:o,sourceLang:t,targetLang:p,sourceLangCode:d,targetLangCode:g,isTwoStepEnabled:w}=e,y=d==="ja"&&g.startsWith("zh");if(w&&y)try{const s=await new Promise((u,m)=>{if(a={resolve:u,reject:m},!r)throw new Error("Inference worker not available for two-step translation.");r.postMessage({type:"translate_full",payload:{text:o,sourceLang:"Japanese",targetLang:"English"}})});if(!(s!=null&&s.trim()))throw new Error("Intermediate English translation failed.");if(!r)throw new Error("Inference worker not available for second step of translation.");r.postMessage({type:"translate_stream",payload:{text:s,sourceLang:"English",targetLang:p}})}catch(n){const s=n instanceof Error?n.message:"Two-step translation failed.";self.postMessage({type:"translation_error",payload:{error:s}}),a=null}else{if(!r){self.postMessage({type:"translation_error",payload:{error:"Inference worker not ready."}});return}r.postMessage({type:"translate_stream",payload:e})}},f=()=>{a&&(a.reject(new DOMException("Translation cancelled.","AbortError")),a=null),r&&r.postMessage({type:"cancel_task"})};self.onmessage=async e=>{const{type:o,payload:t}=e.data;switch(o){case"init":r||(console.log("Controller: Creating inference worker..."),r=new Worker(new URL("/Gemini-AI-Translator/assets/worker-DV4y5aBG.js",self.location.href),{type:"classic"}),i()),l(e);break;case"unload":r?(console.log("Controller: Forwarding unload command to inference worker for graceful shutdown."),r.postMessage({type:"unload"})):(console.log("Controller: Unload called but no inference worker exists."),self.postMessage({type:"unload_done"}));break;case"transcribe":case"extractText":l(e);break;case"translate":await c(t);break;case"cancel_translation":f();break;default:console.warn(`Unknown controller worker message type: ${o}`)}}})();
