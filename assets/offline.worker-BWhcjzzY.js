(function(){"use strict";let t=null,e=null;const i=()=>{t||(t=new Worker(new URL("/Gemini-AI-Translator/assets/worker-D_tvT7rm.js",self.location.href)),t.onmessage=r=>{const{type:a,payload:s}=r.data;if(e&&a==="translation_full_done"){e.resolve(s.result),e=null;return}if(e&&(a==="translation_error"||a==="error")){e.reject(new Error(s.error)),e=null;return}self.postMessage(r.data)},t.onerror=r=>{const a=`Inference worker error: ${r.message}`;e&&(e.reject(new Error(a)),e=null),self.postMessage({type:"init_error",payload:{error:a}})})},o=()=>(t||i(),t),c=async r=>{const{text:a,sourceLang:s,targetLang:p,sourceLangCode:f,targetLangCode:d,isTwoStepEnabled:u}=r,w=f==="ja"&&d.startsWith("zh");if(u&&w)try{const n=await new Promise((m,y)=>{e={resolve:m,reject:y},o().postMessage({type:"translate_full",payload:{text:a,sourceLang:"Japanese",targetLang:"English"}})});if(!(n!=null&&n.trim()))throw new Error("Intermediate English translation failed.");o().postMessage({type:"translate_stream",payload:{text:n,sourceLang:"English",targetLang:p}})}catch(l){const n=l instanceof Error?l.message:"Two-step translation failed.";self.postMessage({type:"translation_error",payload:{error:n}}),e=null}else o().postMessage({type:"translate_stream",payload:r})},g=()=>{e&&(e.reject(new DOMException("Translation cancelled.","AbortError")),e=null),t&&t.postMessage({type:"cancel_task"})};self.onmessage=async r=>{const{type:a,payload:s}=r.data;switch(t||i(),a){case"init":case"unload":case"transcribe":o().postMessage(r.data);break;case"extractText":o().postMessage(r.data,[s.imageBitmap]);break;case"translate":await c(s);break;case"cancel_translation":g();break;default:console.warn(`Unknown controller worker message type: ${a}`)}}})();
