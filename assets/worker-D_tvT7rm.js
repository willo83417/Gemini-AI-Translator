(function(){"use strict";typeof self.HTMLImageElement>"u"&&(self.HTMLImageElement=class{}),typeof self.Image>"u"&&(self.Image=self.HTMLImageElement),typeof self.HTMLVideoElement>"u"&&(self.HTMLVideoElement=class{}),self.exports={},importScripts("/Gemini-AI-Translator/genai_bundle.js");const{FilesetResolver:y,LlmInference:_}=self.exports,x="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-genai@0.10.25/wasm";let o=null,i=null;const w=async s=>{const{modelBlob:r,modelSource:e,options:t}=s;o&&(await o.close(),o=null);try{if(!("gpu"in navigator))throw new Error("WebGPU is not supported.");if(!r)throw new Error(`Model data for ${e} not found.`);const a=URL.createObjectURL(r),n=await y.forGenAiTasks(x),{maxTokens:l=4096,topK:f=40,temperature:c=.3,randomSeed:d=101,supportAudio:m=!1,maxNumImages:p=1}=t;o=await _.createFromOptions(n,{baseOptions:{modelAssetPath:a,delegate:"GPU"},maxTokens:l,topK:f,temperature:c,randomSeed:d,supportAudio:m,maxNumImages:p}),URL.revokeObjectURL(a),self.postMessage({type:"init_done",payload:{modelIdentifier:e}})}catch(a){o=null;const n=a instanceof Error?a.message:"Unknown initialization error.";self.postMessage({type:"init_error",payload:{error:n}})}},b=async()=>{o&&(await o.close(),o=null),self.postMessage({type:"unload_done"})},u=(s,r,e,t)=>{if(!o)throw new Error("Offline model is not initialized.");i=new AbortController;const a=i.signal;return new Promise((n,l)=>{const f=()=>l(new DOMException("Translation cancelled.","AbortError"));a.addEventListener("abort",f,{once:!0});try{let c="";const d=(g,E)=>{a.aborted||(c+=g,t&&self.postMessage({type:"translation_chunk",payload:{chunk:g}}),E&&(a.removeEventListener("abort",f),n(c.trim())))},p=`Translate the following ${r==="Auto Detect"?"auto-detect the source language":`from ${r}`} text into concise ${e}: "${s}". 
 Provide *only* the translated text. Do not include any additional explanations, commentary, or greetings.`;o.generateResponse(p,d)}catch(c){a.removeEventListener("abort",f),l(c)}})},M=async s=>{if(!o)return self.postMessage({type:"extract_text_error",payload:{error:"Offline model not initialized."}});const{imageBitmap:r}=s,e="Extract all text from the following image. Return only the extracted text without any extra comments or explanations.";try{const t=await o.generateResponse([`<start_of_turn>user
${e}
`,{imageSource:r},`<end_of_turn>
<start_of_turn>model
`]);r.close(),self.postMessage({type:"extract_text_done",payload:{text:t.trim()}})}catch(t){console.error("OCR Worker Error:",t);const a=t instanceof Error?t.message:"Offline image text extraction failed.";self.postMessage({type:"extract_text_error",payload:{error:a}})}},h=async s=>{if(!o)return self.postMessage({type:"transcribe_error",payload:{error:"Offline model not initialized."}});const{audioUrl:r,sourceLang:e}=s,a=`Transcribe the following audio. ${e==="Auto Detect"?"Auto-detect the language.":`The language is ${e}.`} Return only the transcribed text.`;try{const n=await o.generateResponse([`<start_of_turn>user
 ${a} <end_of_turn>
<start_of_turn>model
`,{audioSource:r}]);self.postMessage({type:"transcribe_done",payload:{text:n.trim(),audioUrl:r}})}catch(n){const l=n instanceof Error?n.message:"Offline audio transcription failed.";self.postMessage({type:"transcribe_error",payload:{error:l,audioUrl:r}})}};self.onmessage=async s=>{const{type:r,payload:e}=s.data;try{switch(r){case"init":await w(e);break;case"unload":await b();break;case"translate_stream":{const t=await u(e.text,e.sourceLang,e.targetLang,!0);self.postMessage({type:"translation_done",payload:{result:t}});break}case"translate_full":{const t=await u(e.text,e.sourceLang,e.targetLang,!1);self.postMessage({type:"translation_full_done",payload:{result:t}});break}case"cancel_task":i==null||i.abort();break;case"extractText":await M(e);break;case"transcribe":await h(e);break;default:console.warn(`Unknown inference worker message type: ${r}`)}}catch(t){const a=t instanceof DOMException&&t.name==="AbortError",n=r.replace("_stream","").replace("_full","");if(a)self.postMessage({type:"translation_cancelled"});else{const l=t instanceof Error?t.message:`Unknown error in ${r}.`;self.postMessage({type:`${n}_error`,payload:{error:l}})}}finally{i=null}}})();
